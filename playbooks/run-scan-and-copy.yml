---
- name: Run Evaluate-STIG scan and copy results to central share (Flat Structure)
  hosts: all
  gather_facts: yes

  vars:
    # Local Evaluate-STIG install location
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5"

    # Local STIG results folder created by Evaluate-STIG
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # Windows file server share
    share_root: "\\\\192.168.10.198\\STIG-Results"

    # Role ‚Üí folder name on the share (defined per inventory group)
    role_folder: "{{ stig_role_folder | default('Domain-Controllers') }}"

    # Credential handling support (works with either SMB credential type)
    smb_user_effective: "{{ smb_user | default(smb_username) | default(ansible_user) }}"
    smb_pass_effective: "{{ smb_pass | default(smb_password) | default(ansible_password) }}"

  tasks:

    ###########################################################################
    # Ensure Evaluate-STIG.ps1 Exists
    ###########################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
      register: stig_ps1

    - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 not found ‚Äî run prep first."
      when: not stig_ps1.stat.exists


    ###########################################################################
    # Run STIG Scan (CKL + CSV)
    ###########################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        Write-Host "Running Evaluate-STIG..."
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -Output "CKL,CSV" -OutputPath "{{ stig_results_root }}"
        Write-Host "‚úÖ STIG scan complete."
      args:
        executable: PowerShell.exe


    ###########################################################################
    # Copy Results to Windows Share (Flat Copy)
    ###########################################################################
    - name: Copy STIG results to central share
      ansible.windows.win_shell: |
        $srcRoot     = '{{ stig_results_root }}'
        $hostName    = $env:COMPUTERNAME
        $srcHostPath = Join-Path -Path $srcRoot -ChildPath $hostName
        $srcChecklist = Join-Path $srcHostPath 'Checklist'

        if (-not (Test-Path -Path $srcChecklist)) {
          throw "No Evaluate-STIG results found at $srcChecklist"
        }

        $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential -ArgumentList '{{ smb_user_effective }}', $sec

        New-PSDrive -Name 'R' -PSProvider FileSystem -Root '{{ share_root }}' -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = Join-Path 'R:\' '{{ role_folder }}'
        $destHost = Join-Path $rolePath $hostName

        if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }
        if (-not (Test-Path $destHost)) { New-Item -ItemType Directory -Path $destHost -Force | Out-Null }

        Copy-Item -Path (Join-Path $srcHostPath 'Checklist\*') -Destination $destHost -Recurse -Force

        Remove-PSDrive -Name 'R' -Force -ErrorAction SilentlyContinue

        Write-Host "‚úÖ Results copied to {{ share_root }}\\{{ role_folder }}\\$hostName"
      args:
        executable: PowerShell.exe


    ###########################################################################
    # Summary
    ###########################################################################
    - name: ‚úÖ Summary
      debug:
        msg:
          - "‚úÖ STIG scan completed for {{ inventory_hostname }}"
          - "üì§ Results copied to {{ share_root }}\\{{ role_folder }}\\{{ ansible_env.COMPUTERNAME }}"
