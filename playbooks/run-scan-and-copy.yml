---
- name: Run Evaluate-STIG and copy results to central share
  hosts: all
  gather_facts: yes

  vars:
    stig_script: "C:\\ProgramData\\Evaluate-STIG\\Evaluate-STIG.ps1"
    stig_output_dir: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"

    # Provided via AWX Credential: "SMB Domain Account"
    smb_username: "{{ smb_username }}"
    smb_password: "{{ smb_password }}"

  tasks:

    # ---------------------------
    # 1. Ensure Evaluate-STIG exists
    # ---------------------------
    - name: Verify Evaluate-STIG.ps1 is present
      ansible.windows.win_stat:
        path: "{{ stig_script }}"
      register: stig_check

    - name: Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 is missing. Run prep-stig-host first."
      when: not stig_check.stat.exists

    # ---------------------------
    # 2. Run the STIG Scan
    # ---------------------------
    - name: Run Evaluate-STIG
      ansible.windows.win_shell: |
        powershell.exe -ExecutionPolicy Bypass -File "{{ stig_script }}" -OutputPath "{{ stig_output_dir }}"
      args:
        executable: powershell.exe

    # ---------------------------
    # 3. Verify Results Exist
    # ---------------------------
    - name: Verify STIG results exist
      ansible.windows.win_stat:
        path: "{{ stig_output_dir }}"
      register: results_dir

    - name: Stop if no results were created
      ansible.builtin.fail:
        msg: "No STIG results found. Evaluate-STIG produced no output."
      when: not results_dir.stat.exists

    # ---------------------------
    # 4. Map SMB Share to R:
    # ---------------------------
    - name: Map STIG share as R:
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    # ---------------------------
    # 5. Copy files
    # ---------------------------
    - name: Copy results to share
      ansible.windows.win_shell: |
        New-Item -ItemType Directory -Force -Path "R:\\{{ group_names[0] }}\\{{ ansible_hostname }}" | Out-Null
        Copy-Item "{{ stig_output_dir }}\\*" "R:\\{{ group_names[0] }}\\{{ ansible_hostname }}" -Recurse -Force
      args:
        executable: powershell.exe

    # ---------------------------
    # 6. Unmount R:
    # ---------------------------
    - name: Unmap R:
      ansible.windows.win_shell: |
        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: powershell.exe
