---
- name: Generate STIG Rollup Reports (Local execution on appsrv1)
  hosts: appsrv1.voughtnet.local
  gather_facts: no

  vars:
    # The 3 STIG roles you currently use
    roles_to_process:
      - domain_controllers
      - member_servers
      - workstations

    # LOCAL paths on appsrv1 (no UNC/SMB)
    share_root_local: "F:\\STIG-Results"
    reporting_output_local: "F:\\STIG-Results\\Reports"

    # Path to the rollup script on appsrv1
    stig_rollup_script: "C:\\ProgramData\\StigRollup\\StigRollupReport.ps1"

  tasks:

    #########################################################################
    # Debug
    #########################################################################
 
    - name: Debug Share Root Variable
      debug:
        msg: "ShareRoot is: {{ smb_share_root }}"

    ###########################################################################
    # Ensure Reports directory exists
    ###########################################################################
    - name: üßπ Ensure Reports directory exists (Local Path)
      ansible.windows.win_powershell:
        script: |
          $path = "{{ reporting_output_local }}"
          if (-not (Test-Path $path)) {
            New-Item -Path $path -ItemType Directory -Force | Out-Null
          }
      register: ensure_reports_folder


    ###########################################################################
    # Run STIG Rollup for each role
    ###########################################################################
    - name: üìÑ Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          $params = @{
            ShareRoot  = "{{ share_root_local }}"
            RoleName   = "{{ item }}"
            OutputName = "SummaryReport-{{ item }}.html"
          }

          # Execute script; errors bubble naturally to AWX
          & "{{ stig_rollup_script }}" @params
      loop: "{{ roles_to_process }}"
      register: rollup_results


    ###########################################################################
    # Copy each generated HTML file into the Reports folder
    ###########################################################################
    - name: üì§ Move generated reports into Reports folder
      ansible.windows.win_powershell:
        script: |
          $src = "C:\\ProgramData\\StigRollup\\SummaryReport-{{ item }}.html"
          $dst = "{{ reporting_output_local }}"

          if (Test-Path $src) {
            Copy-Item -Path $src -Destination $dst -Force
          } else {
            Write-Host "‚ùå Report file not found for role '{{ item }}'"
          }
      loop: "{{ roles_to_process }}"
