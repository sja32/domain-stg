---
# ============================================================================
#  Generate STIG Rollup Reports ON THE WINDOWS HOST (not controller)
# ============================================================================

- name: Generate STIG Rollup Reports
  hosts: domain_controllers   # <-- OR whichever Windows host you want to run it on
  gather_facts: false
  vars_files:
    - ../vars/stig_settings.yml

  vars:
    remote_script_dir: "C:\\ProgramData\\StigRollup"
    remote_script_path: "{{ remote_script_dir }}\\StigRollupReport.ps1"
    local_script_path: "../scripts/StigRollupReport.ps1"

  tasks:

    # ----------------------------------------------------------------------
    # Create folder on Windows host
    # ----------------------------------------------------------------------
    - name: Create script folder on Windows host
      ansible.windows.win_file:
        path: "{{ remote_script_dir }}"
        state: directory

    # ----------------------------------------------------------------------
    # Copy script from Git repo â†’ Windows host
    # ----------------------------------------------------------------------
    - name: Copy Rollup PS Script to Windows Host
      ansible.windows.win_copy:
        src: "{{ local_script_path }}"
        dest: "{{ remote_script_path }}"
        force: yes

    # ----------------------------------------------------------------------
    # Run script for each role on the Windows host
    # ----------------------------------------------------------------------
    - name: Run STIG Rollup for each Role
      ansible.windows.win_powershell:
        script: |
          & "{{ remote_script_path }}" `
            -ShareRoot "{{ stig_share_root }}" `
            -RoleName "{{ item }}"
      loop: "{{ stig_roles }}"
      register: rollup_results

    # ----------------------------------------------------------------------
    # Debug output
    # ----------------------------------------------------------------------
    - name: Show script output
      ansible.builtin.debug:
        var: rollup_results
