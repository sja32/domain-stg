---
- name: Generate STIG Rollup Reports for All Roles
  hosts: localhost
  gather_facts: no

  vars:
    # Hardcoded SMB share path (escaped properly for PowerShell)
    share_root: "\\\\192.168.10.198\\STIG-Results"

    # List of roles â€“ safe name (NOT using the reserved word 'roles')
    target_roles:
      - domain_controllers
      - member_servers
      - workstations

  tasks:
    - name: Read PowerShell script from file
      ansible.builtin.slurp:
        src: "{{ playbook_dir }}/../scripts/StigRollupReport.ps1"
      register: ps_script_raw

    - name: Decode script content
      ansible.builtin.set_fact:
        ps_script: "{{ ps_script_raw.content | b64decode }}"

    - name: Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          {{ ps_script }}
          StigRollupReport -ShareRoot "{{ share_root }}" -RoleName "{{ item }}" -OutputName "STIG-Rollup_{{ item }}.html"
      loop: "{{ target_roles }}"
      register: report_outputs

    - name: Display output summary
      debug:
        var: report_outputs
