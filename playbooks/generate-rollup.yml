---
- name: Generate STIG Rollup Reports
  hosts: domain_controllers
  gather_facts: no

  vars:
    # UNC path to STIG results root
    share_root_unc: "\\\\192.168.10.198\\STIG-Results"

    # Roles inside the STIG-Results folder
    stig_roles:
      - domain_controllers
      - member_servers
      - workstations

  tasks:

    # -------------------------------------------------------------
    # Ensure ProgramData\StigRollup folder exists on Windows host
    # -------------------------------------------------------------
    - name: Create script folder on Windows host
      ansible.windows.win_file:
        path: "C:\\ProgramData\\StigRollup"
        state: directory

    # -------------------------------------------------------------
    # Copy the Rollup Script to Windows Host
    # (path corrected to match repo structure)
    # -------------------------------------------------------------
    - name: Copy Rollup PS Script to Windows Host
      ansible.windows.win_copy:
        src: "../scripts/StigRollupReport.ps1"
        dest: "C:\\ProgramData\\StigRollup\\StigRollupReport.ps1"

    # -------------------------------------------------------------
    # Run the rollup for each role
    # -------------------------------------------------------------
    - name: Run STIG Rollup for each Role
      ansible.windows.win_powershell:
        script: |
          $params = @{
              ShareRoot = "{{ share_root_unc }}"
              RoleName  = "{{ item }}"
              OutputName = "SummaryReport-Rollup.html"
          }

          & "C:\\ProgramData\\StigRollup\\StigRollupReport.ps1" @params
      loop: "{{ stig_roles }}"
      register: rollup_output

    # -------------------------------------------------------------
    # OPTIONAL: Show results in AWX log
    # -------------------------------------------------------------
    - name: Debug output from rollup script
      debug:
        var: rollup_output
