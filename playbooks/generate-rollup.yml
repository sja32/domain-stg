---
- name: Generate STIG Rollup Reports
  hosts: dc1.voughtnet.local
  gather_facts: no

  vars:
    roles:
      - domain_controllers
      - member_servers
      - workstations

    share_root_unc: "\\\\192.168.10.198\\STIG-Results"
    rollup_dir: "C:\\ProgramData\\StigRollup"
    rollup_script: "{{ rollup_dir }}\\StigRollupReport.ps1"

  tasks:
    ###########################################################################
    # 1. Ensure rollup directory exists
    ###########################################################################
    - name: Ensure rollup directory exists
      ansible.windows.win_file:
        path: "{{ rollup_dir }}"
        state: directory

    ###########################################################################
    # 2. Copy Rollup Script from repo â†’ Windows host
    #
    # IMPORTANT:
    # generate-rollup.yml is inside /tasks/
    # scripts/StigRollupReport.ps1 is in /scripts/
    #
    # Correct relative path = ../../scripts/StigRollupReport.ps1
    ###########################################################################
    - name: Copy rollup script to host
      ansible.windows.win_copy:
        src: "../../scripts/StigRollupReport.ps1"
        dest: "{{ rollup_script }}"
      register: copy_result

    - name: Debug copy result
      debug:
        var: copy_result

    ###########################################################################
    # 3. Execute rollup for each role
    ###########################################################################
    - name: Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          & "{{ rollup_script }}" -ShareRoot "{{ share_root_unc }}" -RoleName "{{ item }}" -OutputName "SummaryReport-{{ item }}.html"
      loop: "{{ roles }}"
