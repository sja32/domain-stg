---
- name: Generate STIG Rollup Reports
  hosts: dc1.voughtnet.local
  gather_facts: no

  vars:
    share_root_unc: "\\\\192.168.10.198\\STIG-Results"

    rollup_roles:
      - domain_controllers
      - member_servers
      - workstations

    rollup_script_dir: "C:\\ProgramData\\StigRollup"
    rollup_script_path: "{{ rollup_script_dir }}\\StigRollupReport.ps1"

  tasks:

    ###########################################################################
    # 1. Ensure destination folder exists on Windows host
    ###########################################################################
    - name: Ensure rollup directory exists
      ansible.windows.win_file:
        path: "{{ rollup_script_dir }}"
        state: directory

    ###########################################################################
    # 2. Copy rollup script to host
    ###########################################################################
    - name: Copy rollup script to host
      ansible.windows.win_copy:
        src: "scripts/StigRollupReport.ps1"
        dest: "{{ rollup_script_path }}"

    ###########################################################################
    # 3. Run STIG Rollup for each role
    ###########################################################################
    - name: Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          Set-ExecutionPolicy Bypass -Scope Process -Forc
