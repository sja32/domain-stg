---
- name: Generate STIG Rollup Reports
  hosts: dc1.voughtnet.local
  gather_facts: no
  vars:
    stig_share_root: "\\192.168.10.198\\STIG-Results"
    reporting_output: "\\192.168.10.198\\STIG-Results\\Reports"
    roles_to_process:
      - domain_controllers
      - member_servers
      - workstations

  tasks:

    - name: Ensure rollup directory exists on host
      ansible.windows.win_file:
        path: C:\ProgramData\StigRollup
        state: directory

    - name: Copy rollup script to host
      ansible.windows.win_copy:
        src: "{{ playbook_dir}}/../scripts/StigRollupReport.ps1"
        dest: C:\ProgramData\StigRollup\StigRollupReport.ps1
        force: yes

    - name: Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          $role = "{{ item }}"
          $script = "C:\ProgramData\StigRollup\StigRollupReport.ps1"

          & $script `
            -ShareRoot "{{ stig_share_root }}" `
            -RoleName $role `
            -OutputName "SummaryReport-$role.html" `
            -OutputFolder "{{ reporting_output }}"
      loop: "{{ roles_to_process }}"
