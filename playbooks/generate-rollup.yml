---
# ============================================================================
#  Generate STIG Rollup Reports
#  Runs ONLY on the controller inside the Windows EE
# ============================================================================

- name: Generate STIG Rollup Reports for All Roles
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/stig_settings.yml

  vars:
    script_path: "/var/lib/awx/projects/{{ tower_project_scm_id }}__{{ tower_project_scm_branch }}/scripts/StigRollupReport.ps1"

  tasks:

    # ------------------------------------------------------------------------
    # Validate the PowerShell rollup script exists
    # ------------------------------------------------------------------------
    - name: ðŸ” Check rollup script exists
      ansible.builtin.stat:
        path: "{{ script_path }}"
      register: ps_script

    - name: âŒ Fail if script missing
      ansible.builtin.fail:
        msg: "Rollup script not found at {{ script_path }}. Fix project path."
      when: not ps_script.stat.exists

    # ------------------------------------------------------------------------
    # Run rollup for each role defined in stig_settings.yml
    # ------------------------------------------------------------------------
    - name: ðŸ“Š Run STIG rollup for each role
      ansible.builtin.command: >
        pwsh -File "{{ script_path }}"
        -ShareRoot "{{ stig_share_root }}"
        -RoleName "{{ item }}"
      loop: "{{ stig_roles }}"
      register: rollup_output
      changed_when: true

    - name: ðŸ“¥ Show output (debug)
      ansible.builtin.debug:
        msg: "{{ rollup_output.results }}"
