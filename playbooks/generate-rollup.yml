---
- name: Generate STIG Rollup Reports for All Roles
  hosts: dc_group
  gather_facts: no

  vars:
    share_root: "\\\\192.168.10.198\\STIG-Results"
    roles:
      - domain_controllers
      - member_servers
      - workstations

    ps_script_path: "/var/lib/awx/projects/_27__01_domain_stg/scripts/StigRollupReport.ps1"

  tasks:

    - name: Ensure rollup script exists
      ansible.windows.win_stat:
        path: "{{ ps_script_path }}"
      register: script_stat

    - name: Fail if script missing
      ansible.builtin.fail:
        msg: "Rollup script not found at {{ ps_script_path }}"
      when: not script_stat.stat.exists

    - name: Read PowerShell script from project folder
      ansible.windows.win_slurp:
        src: "{{ ps_script_path }}"
      register: ps_script_raw

    - name: Decode script content
      set_fact:
        ps_script: "{{ ps_script_raw.content | b64decode }}"

    - name: Run STIG Rollup for each role
      ansible.windows.win_powershell:
        script: |
          {{ ps_script }}
          StigRollupReport -ShareRoot "{{ share_root }}" -RoleName "{{ item }}" -OutputName "STIG-Rollup.html"
      loop: "{{ roles }}"
      register: rollup_result

    - name: Show results
      debug:
        var: rollup_result
