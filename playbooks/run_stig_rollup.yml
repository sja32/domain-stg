---
- name: Run STIG Rollup for all roles (Linux controller only)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/stig_settings.yml

  vars:
    tmp_root: "/tmp/stig_rollup"
    report_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M') }}"

  tasks:

    ###########################################################################
    # PREP TEMP FOLDER
    ###########################################################################
    - name: Ensure AWX tmp folder exists (Linux controller)
      file:
        path: "{{ tmp_root }}"
        state: directory
        mode: "0755"

    - name: ðŸ” Show loaded STIG rollup settings
      debug:
        msg:
          - "Share Root: {{ stig_share_root }}"
          - "Roles: {{ stig_roles }}"
          - "Master Report Path: {{ stig_master_report_path }}"
          - "Using pure Linux-mode SMB tools (username/password from AWX credential)"

    ###########################################################################
    # ENSURE MASTER REPORT FOLDER EXISTS ON SMB SHARE
    ###########################################################################
    - name: ðŸ“ Ensure master report folder exists (Reports/)
      command: >
        smbclient "{{ stig_share_root }}" "{{ password }}"
        -U "{{ username }}"
        -c "mkdir Reports"
      ignore_errors: yes


    ###########################################################################
    # LOOP THROUGH ROLES AND PROCESS EACH ONE
    ###########################################################################
    - name: ðŸ”„ Process each STIG role folder
      include_tasks: "tasks/process_role.yml"
      loop_control:
        loop_var: role_name
      
        #######################################################################
        # CHECK ROLE FOLDER EXISTS
        #######################################################################
        - name: ðŸ“‚ Check if role folder exists on SMB share
          command: >
            smbclient "{{ stig_share_root }}" "{{ password }}"
            -U "{{ username }}"
            -c "ls {{ role_name }}"
          register: role_check
          failed_when: false

        - name: âŒ Fail if role folder is missing
          fail:
            msg: "Role folder does not exist on SMB share: {{ role_name }}"
          when: "'NT_STATUS_OBJECT_NAME_NOT_FOUND' in role_check.stderr"


        #######################################################################
        # DOWNLOAD ROLE FOLDER LOCALLY
        #######################################################################
        - name: ðŸ“¨ Sync role folder from SMB to controller
          synchronize:
            mode: pull
            src: "{{ stig_share_root }}/{{ role_name }}"
            dest: "{{ tmp_root }}/"
            rsync_opts:
              - "--chmod=755"
            rsync_path: "rsync"
          delegate_to: localhost


        #######################################################################
        # GENERATE HTML REPORT LOCALLY
        #######################################################################
        - name: ðŸ“Š Generate HTML rollup report
          template:
            src: "../templates/rollup_report.j2"
            dest: "{{ tmp_root }}/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html"


        #######################################################################
        # UPLOAD REPORT BACK TO SMB SHARE
        #######################################################################
        - name: â¬†ï¸ Upload HTML rollup report back to SMB share
          command: >
            smbclient "{{ stig_share_root }}" "{{ password }}"
            -U "{{ username }}"
            -c "put {{ tmp_root }}/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html Reports/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html"


    ###########################################################################
    # DONE
    ###########################################################################
    - name: ðŸŽ‰ All rollups complete
      debug:
        msg: "STIG Rollup HTML reports generated and uploaded successfully."
