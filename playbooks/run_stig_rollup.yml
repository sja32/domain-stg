---
- name: Run STIG Rollup for all roles (Linux controller only)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/stig_settings.yml

  vars:
    tmp_root: "/tmp/stig_rollup"
    report_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M') }}"

  tasks:

    ###########################################################################
    # PREP TEMP FOLDER
    ###########################################################################
    - name: Ensure AWX tmp folder exists (Linux controller)
      file:
        path: "{{ tmp_root }}"
        state: directory
        mode: "0755"

    - name: ðŸ” Show loaded STIG rollup settings
      debug:
        msg:
          - "Share Root: {{ stig_share_root }}"
          - "Roles: {{ stig_roles }}"
          - "Master Report Path: {{ stig_master_report_path }}"
          - "Using pure Linux-mode SMB tools"

    ###########################################################################
    # ENSURE MASTER REPORT FOLDER EXISTS (NO POWERSHELL)
    ###########################################################################
    - name: ðŸ“ Ensure master report folder exists on SMB share
      command: >
        smbclient "{{ stig_share_root }}" "{{ smb_password }}"
        -U "{{ smb_username }}"
        -c "mkdir Reports"
      ignore_errors: yes

    ###########################################################################
    # LOOP THROUGH ROLES AND BUILD REPORTS (valid YAML, no block-loop error)
    ###########################################################################
    - name: ðŸ”„ Process each STIG role folder
      block:

        - name: ðŸ“‚ Ensure role exists on SMB share
          command: >
            smbclient "{{ stig_share_root }}" "{{ smb_password }}"
            -U "{{ smb_username }}"
            -c "ls {{ item }}"
          register: role_check
          failed_when: false

        - name: âŒ Fail if role folder does not exist
          fail:
            msg: "Role folder not found on SMB share: {{ item }}"
          when: "'NT_STATUS_OBJECT_NAME_NOT_FOUND' in role_check.stderr"

        #######################################################################
        # DOWNLOAD RESULTS FROM SMB SHARE
        #######################################################################
        - name: ðŸ“¨ Sync role folder from SMB to controller
          synchronize:
            mode: pull
            src: "{{ stig_share_root }}/{{ item }}"
            dest: "{{ tmp_root }}/"
            rsync_opts:
              - "--chmod=755"
            rsync_path: "rsync"
          delegate_to: localhost

        #######################################################################
        # GENERATE HTML REPORT
        #######################################################################
        - name: ðŸ“Š Generate HTML rollup report
          template:
            src: "../templates/rollup_report.j2"
            dest: "{{ tmp_root }}/STIG-Rollup_{{ item }}_{{ report_timestamp }}.html"

        #######################################################################
        # UPLOAD REPORT BACK TO SMB SHARE
        #######################################################################
        - name: â¬†ï¸ Upload rollup report to SMB share
          command: >
            smbclient "{{ stig_share_root }}" "{{ smb_password }}"
            -U "{{ smb_username }}"
            -c "put {{ tmp_root }}/STIG-Rollup_{{ item }}_{{ report_timestamp }}.html Reports/STIG-Rollup_{{ item }}_{{ report_timestamp }}.html"

      with_items: "{{ stig_roles }}"


        #######################################################################
        # DOWNLOAD RESULTS FROM SMB SHARE
        #######################################################################
        - name: ðŸ“¨ Sync role folder from SMB to controller
          synchronize:
            mode: pull
            src: "{{ stig_share_root }}/{{ role_name }}"
            dest: "{{ tmp_root }}/"
            rsync_opts:
              - "--chmod=755"
            rsync_path: "rsync"
          delegate_to: localhost

        #######################################################################
        # GENERATE HTML REPORT (LINUX, NO POWERSHELL)
        #######################################################################
        - name: ðŸ“Š Generate HTML rollup report
          template:
            src: "../templates/rollup_report.j2"
            dest: "{{ tmp_root }}/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html"

        #######################################################################
        # UPLOAD REPORT BACK TO SMB SHARE
        #######################################################################
        - name: â¬†ï¸ Upload rollup report to SMB share
          command: >
            smbclient "{{ stig_share_root }}" "{{ smb_password }}"
            -U "{{ smb_username }}"
            -c "put {{ tmp_root }}/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html Reports/STIG-Rollup_{{ role_name }}_{{ report_timestamp }}.html"

    ###########################################################################
    # DONE
    ###########################################################################
    - name: ðŸŽ‰ All rollups complete
      debug:
        msg: "STIG Rollup HTML reports generated and uploaded successfully."
