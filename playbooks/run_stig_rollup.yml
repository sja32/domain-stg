---
- name: Run STIG Rollup for all roles (controller-side, PowerShell only)
  hosts: localhost
  gather_facts: false

  vars:
    ansible_remote_tmp: "/tmp/ansible-tmp"

  vars_files:
    - "../vars/stig_settings.yml"

  tasks:

    - name: Ensure AWX tmp folder exists
      ansible.builtin.file:
        path: "/tmp/ansible-tmp"
        state: directory
        mode: "1777"
      delegate_to: localhost

    - name: üîç Show loaded STIG rollup settings
      debug:
        msg:
          - "PowerShell: {{ powershell_path }}"
          - "Share Root: {{ stig_share_root }}"
          - "Roles: {{ stig_roles }}"
          - "Master Report Path (future use): {{ stig_master_report_path }}"

    ###################################################################
    # 1) Ensure master report folder exists (optional, future use)
    ###################################################################
    - name: üìÅ Ensure master report folder exists (PowerShell)
      ansible.builtin.command: >
        {{ powershell_path }} -ExecutionPolicy Bypass
        -Command "New-Item -ItemType Directory -Force -Path '{{ stig_master_report_path }}' | Out-Null"
      changed_when: false

    ###################################################################
    # 2) Ensure role folders exist under the share (defensive)
    ###################################################################
    - name: üìÅ Ensure role folders exist under {{ stig_share_root }} (PowerShell)
      ansible.builtin.command: >
        {{ powershell_path }} -ExecutionPolicy Bypass
        -Command "New-Item -ItemType Directory -Force -Path '{{ stig_share_root }}\\{{ item }}' | Out-Null"
      loop: "{{ stig_roles }}"
      changed_when: false

    ###################################################################
    # 3) Run your existing StigRollupReport.ps1 once per role
    ###################################################################
    - name: ‚ñ∂ Run STIG rollup for each role (PowerShell)
      ansible.builtin.command: >
        {{ powershell_path }} -ExecutionPolicy Bypass
        -File "{{ playbook_dir }}/../scripts/StigRollupReport.ps1"
        -ShareRoot "{{ stig_share_root }}"
        -RoleName "{{ item }}"
        -OutputName "STIG-Rollup.html"
      loop: "{{ stig_roles }}"
      register: rollup_output
      changed_when: false

    ###################################################################
    # 4) Display output from the last PowerShell call (for logs)
    ###################################################################
    - name: üñ•Ô∏è Show PowerShell rollup output (last run)
      debug:
        var: rollup_output.results[-1].stdout_lines
