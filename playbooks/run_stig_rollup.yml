---
# Run STIG Rollup for all roles (Linux controller only)
- name: Run STIG Rollup for all roles (Linux controller only)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/stig_settings.yml

  vars:
    tmp_root: "/tmp/stig_rollup"
    report_timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M') }}"

  tasks:

    ###########################################################################
    # PREP TEMP FOLDER
    ###########################################################################
    - name: Ensure AWX tmp folder exists (Linux controller)
      file:
        path: "{{ tmp_root }}"
        state: directory
        mode: "0755"

    - name: ðŸ” Show loaded STIG rollup settings
      debug:
        msg:
          - "Share Root: {{ stig_share_root }}"
          - "Roles: {{ stig_roles }}"
          - "Master Report Path: {{ stig_master_report_path }}"
          - "Using pure Linux-mode SMB tools"

    ###########################################################################
    # ENSURE MASTER REPORT FOLDER EXISTS ON SMB SHARE
    ###########################################################################
    - name: ðŸ“ Ensure master report folder exists (Reports/)
      command: >
        smbclient "{{ stig_share_root }}" "{{ smb_password }}"
        -U "{{ smb_username }}"
        -c "mkdir Reports"
      ignore_errors: yes

    ###########################################################################
    # LOOP THROUGH ROLES
    ###########################################################################
    - name: ðŸ”„ Process each STIG role folder
      include_tasks: "tasks/process_role.yml"
      loop: "{{ stig_roles }}"
      loop_control:
        loop_var: role_name

    ###########################################################################
    # DONE
    ###########################################################################
    - name: ðŸŽ‰ All rollups complete
      debug:
        msg: "STIG Rollup HTML reports generated and uploaded successfully."
