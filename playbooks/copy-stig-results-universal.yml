---
- name: Copy Evaluate-STIG results to central Windows share (Universal, Clean)
  hosts: all
  gather_facts: no

  tasks:

  - name: Get hostname (PowerShell, clean output)
    ansible.windows.win_shell: |
      (hostname).Trim()
    register: host_name

  - name: Set normalized hostname
    set_fact:
      stig_target_hostname: "{{ host_name.stdout }}"

  - name: Ensure destination folder exists (PowerShell, not win_file)
    ansible.windows.win_shell: |
      $dest = "{{ results_share_root }}\Domain-Controllers\{{ stig_target_hostname }}"
      if (-Not (Test-Path $dest)) {
        New-Item -ItemType Directory -Path $dest -Force | Out-Null
      }
      Write-Output "Destination ready: $dest"

  - name: Copy STIG results folder (PowerShell, direct copy)
    ansible.windows.win_shell: |
      $src = "{{ stig_local_path }}\Results"
      $dest = "{{ results_share_root }}\Domain-Controllers\{{ stig_target_hostname }}"
      Copy-Item -Path $src -Destination $dest -Recurse -Force
      Write-Output "Copied: $src to $dest"
