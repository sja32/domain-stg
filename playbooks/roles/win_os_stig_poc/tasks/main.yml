---
# =====================================================================
#  Windows OS STIG Remediation ‚Äì Main Task Logic (v3)
#  Supports:
#   ‚Ä¢ PoC default controls (enabled flags)
#   ‚Ä¢ Extended remediation list (stig_remediation_list)
#   ‚Ä¢ AWX-safe file validation
# =====================================================================

- name: Load control map
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/control_map.yml"
  register: control_map

- name: üìù Display selected STIG controls for remediation
  ansible.builtin.debug:
    msg: |
      *****************************************************
      Windows OS STIG Remediation (PoC)
      Target Host: {{ inventory_hostname }}
      Selected Controls:
      {% for x in (win_os_stig_poc_effective_list | default([])) %}
      - {{ x }}
      {% endfor %}
      *****************************************************

# ---------------------------------------------------------------------
# MERGE:
#  1. enabled PoC controls
#  2. extended stig_remediation_list
# ---------------------------------------------------------------------

- name: Build effective remediation list
  ansible.builtin.set_fact:
    win_os_stig_poc_effective_list: >-
      {{
        (
          win_os_stig_poc_controls | dict2items
        )
        | selectattr('value.enabled', 'equalto', true)
        | map(attribute='key')
        | list
      +
        (
          stig_remediation_list | default([]) | list
        )
      | unique
      }}

- name: üß© Effective control list (post-merge)
  ansible.builtin.debug:
    var: win_os_stig_poc_effective_list

# ---------------------------------------------------------------------
# VALIDATE CONTROLS EXIST IN CONTROL MAP
# ---------------------------------------------------------------------

- name: ‚ùó Validate each V-ID exists in win_os_stig_poc_control_map
  ansible.builtin.assert:
    that:
      - item in win_os_stig_poc_control_map
    fail_msg: "ERROR: '{{ item }}' is not defined in control_map.yml"
    success_msg: "'{{ item }}' exists in control_map.yml"
  loop: "{{ win_os_stig_poc_effective_list }}"
  ignore_errors: false
  when: win_os_stig_poc_effective_list is defined

# ---------------------------------------------------------------------
# VALIDATE REMEDIATION FILES EXIST (AWX-SAFE)
# ---------------------------------------------------------------------

- name: Check if remediation task file exists (controller)
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/roles/win_os_stig_poc/tasks/{{ item }}.yml"
  register: remediation_files
  delegate_to: localhost
  loop: "{{ win_os_stig_poc_effective_list }}"

- name: ‚ùó Fail if any remediation file is missing
  ansible.builtin.fail:
    msg: "‚ùå Missing remediation file for {{ result.item }}. Expected: playbooks/roles/win_os_stig_poc/tasks/{{ result.item }}.yml"
  when: not result.stat.exists
  loop: "{{ remediation_files.results }}"
  loop_control:
    loop_var: result

# ---------------------------------------------------------------------
# APPLY REMEDIATION FOR EACH CONTROL
# ---------------------------------------------------------------------

- name: ‚ñ∂Ô∏è Execute remediation controls
  ansible.builtin.include_tasks:
    file: "{{ item }}.yml"
  loop: "{{ win_os_stig_poc_effective_list }}"

# ---------------------------------------------------------------------
# FINAL REPORT
# ---------------------------------------------------------------------

- name: üü¢ All selected STIG controls have been remediated
  ansible.builtin.debug:
    msg: |
      *****************************************************
      COMPLETE:
      Remediation applied to the following controls:
      {{ win_os_stig_poc_effective_list }}
      *****************************************************
