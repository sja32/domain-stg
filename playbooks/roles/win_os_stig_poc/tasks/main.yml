---
# ----------------------------------------------------------------------
#  Load control map (maps V-IDs â†’ task file paths)
# ----------------------------------------------------------------------
- name: Load control map
  ansible.builtin.include_vars:
    file: control_map.yml

# ----------------------------------------------------------------------
#  Display selected controls (either from inventory or control_map)
# ----------------------------------------------------------------------
- name: ğŸ“ Display selected STIG controls for remediation
  ansible.builtin.debug:
    msg: |
      *****************************************************
      Windows OS STIG Remediation (PoC)
      Target Host: {{ inventory_hostname }}
      Selected Controls:
      {{ (stig_remediation_list | default(windows_selected_controls)) | to_nice_yaml }}
      *****************************************************
  vars:
    windows_selected_controls: >-
      {{ win_os_stig_poc_controls
          | dict2items
          | selectattr('value.enabled', 'equalto', true)
          | map(attribute='key')
          | list }}

# ----------------------------------------------------------------------
#  Determine which controls we are actually going to run
# ----------------------------------------------------------------------
- name: Build effective remediation list
  ansible.builtin.set_fact:
    win_os_stig_poc_effective_list: >-
      {{ stig_remediation_list
        | default(
            win_os_stig_poc_controls
            | dict2items
            | selectattr('value.enabled', 'equalto', true)
            | map(attribute='key')
            | list
        )
      }}

- name: ğŸ§© Effective control list (post-merge)
  ansible.builtin.debug:
    var: win_os_stig_poc_effective_list

# ----------------------------------------------------------------------
#  VALIDATION BLOCK â€” Ensures nothing runs if mapping/files are bad
# ----------------------------------------------------------------------
- name: ğŸ” Validate control map entries before executing remediation
  block:

    # --- Check if the V-ID exists in the mapping file ---
    - na
