---
# ================================================================
#  Load Control Map
# ================================================================
- name: Load control map
  ansible.builtin.include_vars:
    file: control_map.yml

# ================================================================
#  Display Selected Controls
# ================================================================
- name: üìù Display selected STIG controls for remediation
  ansible.builtin.debug:
    msg: |
      *****************************************************
      Windows OS STIG Remediation (PoC)
      Target Host: {{ inventory_hostname }}
      Selected Controls:
      {{ (stig_remediation_list | default(windows_selected_controls)) | to_nice_yaml }}
      *****************************************************
  vars:
    windows_selected_controls: >-
      {{ win_os_stig_poc_controls
          | dict2items
          | selectattr('value.enabled','equalto',true)
          | map(attribute='key')
          | list }}

# ================================================================
#  Build List of Controls to Actually Run
# ================================================================
- name: Build effective remediation list
  ansible.builtin.set_fact:
    win_os_stig_poc_effective_list: >-
      {{ stig_remediation_list
          | default(
              win_os_stig_poc_controls
              | dict2items
              | selectattr('value.enabled','equalto',true)
              | map(attribute='key')
              | list )
      }}

- name: üß© Effective control list (post-merge)
  ansible.builtin.debug:
    var: win_os_stig_poc_effective_list

# ================================================================
#  VALIDATION ‚Äî Ensure mapping is correct for each V-ID
# ================================================================
- name: ‚ùó Validate each V-ID exists in win_os_stig_poc_control_map
  ansible.builtin.fail:
    msg: "‚ùå No mapping found for {{ item }} in win_os_stig_poc_control_map!"
  when: win_os_stig_poc_control_map[item] is not defined
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"

# ================================================================
#  File Existence Check on Controller
# ================================================================
- name: Check if remediation task file exists (controller)
  ansible.builtin.stat:
    path: "{{ win_os_stig_poc_control_map[item] }}"
  register: task_file_stat
  delegate_to: localhost
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"

# ================================================================
#  AWX-SAFE Failure if ANY file missing
# ================================================================
- name: ‚ùó Fail if any remediation file is missing
  ansible.builtin.fail:
    msg: >
      ‚ùå Missing remediation file for {{ result.item }}.
      Expected: {{ win_os_stig_poc_control_map[result.item] }}
  when: not result.stat.exists
  loop: "{{ task_file_stat.results }}"
  loop_control:
    loop_var: result
    label: "{{ result.item }}"
  delegate_to: localhost
  run_once: true

# ================================================================
#  Execute Remediation Tasks
# ================================================================
- name: Run remediation tasks for each selected control
  ansible.builtin.include_tasks: "{{ win_os_stig_poc_control_map[item] }}"
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"

# ================================================================
#  Final Message
# ================================================================
- name: üü¢ All selected STIG controls have been remediated
  ansible.builtin.debug:
    msg: |
      *****************************************************
      COMPLETE:
      Remediation applied to the following controls:
      {{ win_os_stig_poc_effective_list }}
      *****************************************************

