---
# ----------------------------------------------------------------------
#  Load control map
# ----------------------------------------------------------------------
- name: Load control map
  ansible.builtin.include_vars:
    file: control_map.yml

# ----------------------------------------------------------------------
#  Display selected controls
# ----------------------------------------------------------------------
- name: üìù Display selected STIG controls for remediation
  ansible.builtin.debug:
    msg: |
      *****************************************************
      Windows OS STIG Remediation (PoC)
      Target Host: {{ inventory_hostname }}
      Selected Controls:
      {{ (stig_remediation_list | default(windows_selected_controls)) | to_nice_yaml }}
      *****************************************************
  vars:
    windows_selected_controls: >-
      {{ win_os_stig_poc_controls
          | dict2items
          | selectattr('value.enabled', 'equalto', true)
          | map(attribute='key')
          | list }}

# ----------------------------------------------------------------------
#  Build effective list
# ----------------------------------------------------------------------
- name: Build effective remediation list
  ansible.builtin.set_fact:
    win_os_stig_poc_effective_list: >-
      {{ stig_remediation_list
        | default(
            win_os_stig_poc_controls
            | dict2items
            | selectattr('value.enabled', 'equalto', true)
            | map(attribute='key')
            | list
          )
      }}

- name: üß© Effective control list (post-merge)
  ansible.builtin.debug:
    var: win_os_stig_poc_effective_list


# ----------------------------------------------------------------------
# VALIDATION 1 ‚Äî V-ID exists in control_map.yml
# ----------------------------------------------------------------------
- name: ‚ùó Validate each V-ID exists in win_os_stig_poc_control_map
  ansible.builtin.fail:
    msg: >
      ‚ùå ERROR: V-ID {{ item }} is NOT defined in control_map.yml.
      Add it under win_os_stig_poc_control_map.
  when: win_os_stig_poc_control_map[item] is not defined
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"


# ----------------------------------------------------------------------
# VALIDATION 2 ‚Äî Check if the remediation task file exists
# ----------------------------------------------------------------------
- name: Check if remediation task file exists
  ansible.builtin.stat:
    path: "/runner/project/{{ win_os_stig_poc_control_map[item] }}"
  register: task_file_stat
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"


- name: ‚ùó Fail if any remediation file is missing
  ansible.builtin.fail:
    msg: >
      ‚ùå ERROR: Missing remediation file for {{ item }}.
      Expected at: /runner/project/{{ win_os_stig_poc_control_map[item] }}
  when: not task_file_stat.results[loop.index0].stat.exists
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"


# ----------------------------------------------------------------------
#  Validation complete
# ----------------------------------------------------------------------
- name: ‚úÖ Validation complete ‚Äî all files present
  ansible.builtin.debug:
    msg: "All validation passed ‚Äî proceeding with remediation."


# ----------------------------------------------------------------------
#  Execute remediation
# ----------------------------------------------------------------------
- name: Run remediation tasks for each selected control
  ansible.builtin.include_tasks: "{{ win_os_stig_poc_control_map[item] }}"
  loop: "{{ win_os_stig_poc_effective_list }}"
  loop_control:
    label: "{{ item }}"


# ----------------------------------------------------------------------
#  Completion banner
# ----------------------------------------------------------------------
- name: üü¢ All selected STIG controls have been remediated
  ansible.builtin.debug:
    msg: |
      *****************************************************
      COMPLETE:
      Remediation applied to the following controls:
      {{ win_os_stig_poc_effective_list }}
      *****************************************************
