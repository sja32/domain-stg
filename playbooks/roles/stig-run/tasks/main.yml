---
- name: Beautiful STIG Runner
  ansible.windows.win_shell: |
    function Banner($Text) { Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan; Write-Host " $Text" -ForegroundColor White; Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`n" -ForegroundColor Cyan }

    Banner "ğŸš€  Starting Evaluate-STIG Scan on $env:COMPUTERNAME"

    $User = "{{ ansible_user }}"
    $Pass = "{{ ansible_password }}" | ConvertTo-SecureString -AsPlainText -Force
    $Cred = New-Object System.Management.Automation.PSCredential($User, $Pass)

    # Map Evaluate-STIG share
    Write-Host "ğŸ”„  Mapping Evaluate-STIG Share..." -NoNewline
    New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_eval }}" -Credential $Cred -ErrorAction Stop | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    # Ensure local install directory exists + refresh contents
    $LocalPath = "{{ stig_local_path }}\{{ stig_version }}"
    Write-Host "ğŸ“  Ensuring Local Install Folder Exists..." -NoNewline
    if (-Not (Test-Path $LocalPath)) {
        New-Item -ItemType Directory -Path $LocalPath -Force | Out-Null
        Copy-Item "Z:\{{ stig_version }}" "{{ stig_local_path }}" -Recurse -Force
    }
    Write-Host " âœ…" -ForegroundColor Green

    # Import certs
    Write-Host "ğŸ”“  Importing STIG Certificates..." -NoNewline
    & "$LocalPath\Prerequisites\Import-Certificates.bat" | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    # Run prereqs tests
    Write-Host "ğŸ§ª  Running STIG Prerequisite Tests..." -NoNewline
    & "$LocalPath\Prerequisites\Test-Prerequisites.bat" | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    # Execute scan
    Write-Host "`nğŸ”  Executing Evaluate-STIG Scan... (this may take several minutes)`n"
    cd $LocalPath
    .\Evaluate-STIG.ps1 -Output ckl -Summary -ResultsDirectory "C:\ProgramData\Evaluate-STIG\Results" | Out-Null

    # Map STIG Results share
    Write-Host "`nğŸ”„  Mapping STIG Results Share..." -NoNewline
    New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_results }}" -Credential $Cred -ErrorAction Stop | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    # Upload results
    $HN = $env:COMPUTERNAME
    Write-Host "ğŸ“‚  Preparing Results Folder for $HN..." -NoNewline
    New-Item -Path "R:\$HN" -ItemType Directory -Force | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "â¬†ï¸  Uploading Results..."
    Copy-Item "C:\ProgramData\Evaluate-STIG\Results\*" "R:\$HN" -Recurse -Force

    Write-Host "`nâœ…  STIG Scan Complete for $HN" -ForegroundColor Green
    Write-Host "ğŸ“‚  Results: {{ stig_share_results }}\$HN"
  register: stig_output

- debug:
    var: stig_output.stdout_lines
