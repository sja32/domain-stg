---
- name: Full STIG Pipeline (Prep -> Scan -> Upload)
  hosts: all
  gather_facts: yes  # Needed for group_names and ansible_hostname

  vars:
    ###################################################################
    # Paths for Evaluate-STIG
    ###################################################################
    stig_version: "Evaluate-STIG_1.2507.5"

    # Source: UNC share where Evaluate-STIG is stored
    stig_share_path: "\\\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"

    # Destination: C:\ProgramData\Evaluate-STIG on each host
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"

    # Local results created by Evaluate-STIG
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # Final UNC share for results
    smb_share_root: "\\\\192.168.10.198\\STIG-Results"

    ###################################################################
    # Map host ‚Üí role folder (only your 3 groups matter)
    ###################################################################
    role_folder: >-
      {{
        (group_names
          | select('in', ['domain_controllers', 'member_servers', 'workstations'])
          | list
          | first
        ) | default('unassigned')
      }}

    ###################################################################
    # SMB credentials (survey > machine credential fallback)
    ###################################################################
    smb_user_effective: "{{ smb_user | default(ansible_user) }}"
    smb_pass_effective: "{{ smb_pass | default(ansible_password) }}"

  tasks:
    ###################################################################
    # 1. PREP ‚Äî Clean and redeploy Evaluate-STIG
    ###################################################################
    - name: üöÄ Remove existing Evaluate-STIG directory
      ansible.windows.win_powershell:
        script: |
          $path = "{{ stig_local_path }}"
          if (Test-Path $path) {
            Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
          }

    - name: üìÅ Create Evaluate-STIG directory
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: üì• Copy Evaluate-STIG to host
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          New-PSDrive -Name 'Z' -PSProvider FileSystem -Root '{{ stig_share_path }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {
            Copy-Item -Path 'Z:\*' -Destination '{{ stig_local_path }}' -Recurse -Force -ErrorAction Stop
          }
          finally {
            Remove-PSDrive -Name 'Z' -Force -ErrorAction SilentlyContinue
          }

    ###################################################################
    # 2. SCAN ‚Äî Run Evaluate-STIG (CKL + CSV + Summary)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "C:\ProgramData\{{ stig_version }}"
        .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV,Summary"
      args:
        executable: PowerShell.exe

    - name: ‚úÖ Scan complete
      ansible.builtin.debug:
        msg: "STIG scan complete on {{ inventory_hostname }}"

    ###################################################################
    # 3. VERIFY ‚Äî Make sure Evaluate-STIG produced results
    ###################################################################
    - name: üîé Verify local STIG results exist
      ansible.windows.win_powershell:
        script: |
          $srcHost = Join-Path '{{ stig_results_root }}' $env:COMPUTERNAME
          $srcChecks = Join-Path $srcHost 'Checklist'
          if (-not (Test-Path $srcChecks)) {
            throw "No Evaluate-STIG results at $srcChecks"
          }

    ###################################################################
    # 4. CLEANUP ‚Äî clear old results before copying new ones
    ###################################################################
    - name: üßπ Clear existing Checklist results on SMB share
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          New-PSDrive -Name 'R' -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {
            $rolePath = Join-Path 'R:\' '{{ role_folder }}'
            $hostPath = Join-Path $rolePath $env:COMPUTERNAME
            $checklistPath = Join-Path $hostPath 'Checklist'

            if (Test-Path $checklistPath) {
              Get-ChildItem -Path $checklistPath -Recurse -Force |
                Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
            }
          }
          finally {
            Remove-PSDrive -Name 'R' -Force -ErrorAction SilentlyContinue
          }

    ###################################################################
    # 5. UPLOAD ‚Äî Copy fresh results
    ###################################################################
    - name: üì§ Upload STIG Results to SMB share
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $srcRoot  = '{{ stig_results_root }}'
          $hostName = $env:COMPUTERNAME
          $srcHost  = Join-Path $srcRoot $hostName
          $srcChecks = Join-Path $srcHost 'Checklist'

          if (-not (Test-Path $srcChecks)) {
            throw "No Evaluate-STIG results at $srcChecks"
          }

          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          # Mount the STIG-Results share
          New-PSDrive -Name 'R' -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {

            # R:\Role
            $rolePath = Join-Path 'R:\' '{{ role_folder }}'
            if (-not (Test-Path $rolePath)) {
              New-Item -ItemType Directory -Path $rolePath -Force | Out-Null
            }

            # R:\Role\Hostname
            $destHost = Join-Path $rolePath $hostName
            if (-not (Test-Path $destHost)) {
              New-Item -ItemType Directory -Path $destHost -Force | Out-Null
            }

            # R:\Role\Hostname\Checklist
            $destChecklist = Join-Path $destHost 'Checklist'
            if (-not (Test-Path $destChecklist)) {
              New-Item -ItemType Directory -Path $destChecklist -Force | Out-Null
            }

            # Copy results ‚Üí Checklist folder
            Copy-Item -Path (Join-Path $srcChecks '*') -Destination $destChecklist -Recurse -Force

            "Copied results to $destChecklist"
          }
          finally {
            Remove-PSDrive -Name 'R' -Force -ErrorAction SilentlyContinue
          }

    ###################################################################
    # Summary
    ###################################################################
    - name: üìä Pipeline summary
      ansible.builtin.debug:
        msg:
          - "Local results: {{ stig_results_root }}\\{{ ansible_hostname }}\\Checklist"
          - "Uploaded to:  {{ smb_share_root }}\\{{ role_folder }}\\{{ ansible_hostname }}\\Checklist"
