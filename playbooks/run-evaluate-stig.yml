---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no

  vars:
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5"
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\stig-results"

  tasks:

    ###################################################################
    # Verify Evaluate-STIG Exists
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
      register: stig_ps1

    - name: ‚ùå Fail if Evaluate-STIG.ps1 not found
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 not found in {{ stig_workdir }} ‚Äî run prep first."
      when: not stig_ps1.stat.exists

    ###################################################################
    # Run the STIG Scan (CKL + CSV)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        Write-Host "Running Evaluate-STIG..."
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -Output "CKL,CSV" -OutputPath "{{ stig_results }}"
        Write-Host "‚úÖ STIG scan complete."
      args:
        executable: PowerShell.exe
      register: stig_scan
      failed_when: false

    ###################################################################
    # Ensure local results folder exists
    ###################################################################
    - name: Ensure local results directory exists
      ansible.windows.win_file:
        path: "{{ stig_results }}"
        state: directory

    ###################################################################
    # Create per-host folder on SMB Share
    ###################################################################
       - name: Create hostname folder on SMB share
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString '{{ ansible_password }}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ('{{ ansible_user }}', $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null

        if (-not (Test-Path "R:\{{ stig_role_folder }}")) {
            New-Item -ItemType Directory -Path "R:\{{ stig_role_folder }}" | Out-Null
        }

        if (-not (Test-Path "R:\{{ stig_role_folder }}\{{ inventory_hostname }}")) {
            New-Item -ItemType Directory -Path "R:\{{ stig_role_folder }}\{{ inventory_hostname }}" | Out-Null
        }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe


    ###################################################################
    # Upload Results (Only the newest Checklist folder)
    ###################################################################
    - name: Upload latest STIG results to share
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $src = Join-Path "{{ stig_results }}" "{{ inventory_hostname }}\Checklist"
        $dest = "R:\{{ inventory_hostname }}"

        if (Test-Path $src) {
            Copy-Item "$src\*" $dest -Recurse -Force
            Write-Host "‚úÖ Copied results from $src to $dest"
        } else {
            Write-Host "‚ö†Ô∏è No Checklist results folder found at: $src"
        }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe



    ###################################################################
    # Summary
    ###################################################################
    - name: ‚úÖ Summary
      debug:
        msg:
          - "‚úÖ STIG Scan completed on {{ inventory_hostname }}"
          - "üì§ Results uploaded to: {{ smb_share_root }}\\{{ inventory_hostname }}"
