---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no

  vars:
    # Local Evaluate-STIG install location
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5"

    # STIG results path created by Evaluate-STIG
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # SMB Share root where results go
    smb_share_root: "\\\\192.168.10.198\\stig-results"

    # Group-level variable from AWX (i.e., Domain-Controllers, Member-Servers, Workstations)
    stig_role_folder: "{{ stig_role_folder | default('Uncategorized') }}"

    # Timestamp format
    timestamp: "{{ lookup('pipe', 'powershell -NoLogo -NoProfile -Command \"(Get-Date).ToString(\\'yyyy-MM-dd_HH-mm\\')\"') }}"

  tasks:

    ###################################################################
    # Ensure Evaluate-STIG.ps1 Exists
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
      register: stig_ps1

    - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 not found ‚Äî run prep first."
      when: not stig_ps1.stat.exists

    ###################################################################
    # Run the STIG Scan (CKL + CSV)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        Write-Host "Running Evaluate-STIG..."
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -Output "CKL,CSV" -OutputPath "{{ stig_results }}"
        Write-Host "‚úÖ STIG scan complete."
      args:
        executable: PowerShell.exe

    ###################################################################
    # Create Timestamp Directory
    ###################################################################
    - name: Create timestamp subfolder locally
      ansible.windows.win_shell: |
        $target = "{{ stig_results }}\\{{ timestamp }}"
        if (-not (Test-Path $target)) { New-Item -ItemType Directory -Path $target | Out-Null }
      args:
        executable: PowerShell.exe

    ###################################################################
    # Create Role + Hostname + Timestamp folder on SMB Share
    ###################################################################
    - name: Create folder on SMB Share for results
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential -ArgumentList "{{ ansible_user }}", $sec

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = "R:\\{{ stig_role_folder }}"
        $hostPath = "$rolePath\\{{ inventory_hostname }}"
        $timePath = "$hostPath\\{{ timestamp }}"

        if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath | Out-Null }
        if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath | Out-Null }
        if (-not (Test-Path $timePath)) { New-Item -ItemType Directory -Path $timePath | Out-Null }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Upload Results to SMB Share under Timestamp
    ###################################################################
    - name: Upload STIG results to timestamped folder
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential -ArgumentList "{{ ansible_user }}", $sec

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $dest = "R:\\{{ stig_role_folder }}\\{{ inventory_hostname }}\\{{ timestamp }}"
        Copy-Item "{{ stig_results }}\\*" $dest -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Summary Output
    ###################################################################
    - name: ‚úÖ Summary
      debug:
        msg:
          - "‚úÖ STIG Scan completed on {{ inventory_hostname }}"
          - "üì§ Results uploaded to: {{ smb_share_root }}\\{{ stig_role_folder }}\\{{ inventory_hostname }}\\{{ timestamp }}"
