---
- name: Run Evaluate-STIG scan and upload results
  hosts: windows_servers
  gather_facts: no
  vars:
    smb_share: "\\\\192.168.10.50\\stig-results"

  tasks:
    ###################################################################
    # Create timestamp on Windows
    ###################################################################
  - name: Generate timestamp on the Windows host
    ansible.windows.win_shell: |
      (Get-Date).ToString('yyyy-MM-dd_HH-mm')
    register: stig_timestamp_raw

  - name: Set timestamp fact
    set_fact:
      stig_timestamp: "{{ stig_timestamp_raw.stdout | trim }}"

    ###################################################################
    # Create results directory with timestamp on SMB share
    ###################################################################
  - name: Create timestamp subfolder on SMB share
    ansible.windows.win_file:
      path: "{{ smb_share }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}"
      state: directory

    ###################################################################
    # Upload STIG results to timestamped folder
    ###################################################################
  - name: Upload STIG results (CKL + CSV) to SMB share
    ansible.windows.win_copy:
      src: "C:\\path\\to\\results\\{{ inventory_hostname }}_*.{ckl,csv}"
      dest: "{{ smb_share }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}\\"
      remote_src: yes
