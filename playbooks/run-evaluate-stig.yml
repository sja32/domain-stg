---
- name: Run Evaluate-STIG scan and upload results
  hosts: domain_controllers
  gather_facts: false

  vars:
    # Correct actual installation path
    stig_script_path: 'C:\ProgramData\Evaluate-STIG_1.2507.5\Evaluate-STIG.ps1'
    stig_output_path: 'C:\ProgramData\Evaluate-STIG_1.2507.5\Results'

    # SMB share where results are uploaded
    stig_results_smb_path: '\\192.168.10.50\stig-results'

    # Result grouping folder for this run
    role_name: 'Domain-Controllers'

  tasks:

    ###################################################################
    # Ensure Evaluate-STIG exists before executing
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_script_path }}"
      register: stig_script_check

    - name: ❌ Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 is missing on {{ inventory_hostname }}."
      when: not stig_script_check.stat.exists

    ###################################################################
    # Run Evaluate-STIG scan to produce CKL + CSV files
    ###################################################################
    - name: ▶️ Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: >
        powershell -NoLogo -NoProfile -ExecutionPolicy Bypass
        -File "{{ stig_script_path }}"
        -OutputPath "{{ stig_output_path }}"
      register: stig_scan_output
      changed_when: true

    ###################################################################
    # Generate timestamp for organized results folder
    ###################################################################
    - name: Generate timestamp on Windows host
      ansible.windows.win_shell: "(Get-Date).ToString('yyyy-MM-dd_HH-mm')"
      register: stig_timestamp_raw

    - name: Store timestamp fact
      set_fact:
        stig_timestamp: "{{ stig_timestamp_raw.stdout | trim }}"

    ###################################################################
    # Create timestamp directory on SMB share
    ###################################################################
    - name: Create timestamp results folder on SMB share
      ansible.windows.win_file:
        path: "{{ stig_results_smb_path }}\\{{ role_name }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}"
        state: directory

    ###################################################################
    # Copy STIG Results (CKL + CSV) to SMB share
    ###################################################################
    - name: Upload STIG results to timestamped folder
      ansible.windows.win_copy:
        src: "{{ stig_output_path }}\\"
        dest: "{{ stig_results_smb_path }}\\{{ role_name }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}\\"
        remote_src: yes

    ###################################################################
    # Done
    ###################################################################
    - name: ✅ Report complete
      ansible.builtin.debug:
        msg: >
          Results uploaded to:
          {{ stig_results_smb_path }}\{{ role_name }}\{{ inventory_hostname }}\{{ stig_timestamp }}
