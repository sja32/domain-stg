---
- name: Run Evaluate-STIG with Evidence + CKL + CSV Export
  hosts: all
  gather_facts: no

  vars:
    # Version folder name must match what was copied during prep
    stig_version: "Evaluate-STIG_1.2507.5"

    # Path where Evaluate-STIG lives
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"

    # Local export location for evidence + results
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance"

  tasks:

    - name: ▶️ Run Evaluate-STIG (NonInteractive + CKL + CSV)
      ansible.windows.win_powershell:
        script: |
          Write-Host "Running Evaluate-STIG..."
          & "{{ stig_local_path }}\\Evaluate-STIG.ps1" `
            -NonInteractive `
            -EvidenceFolder "{{ stig_results_local }}" `
            -Output CKL,CSV
        error_action: stop
      args:
        executable: PowerShell.exe

    - name: ✅ Completed Scan
      ansible.builtin.debug:
        msg: "STIG scan completed and results exported on {{ inventory_hostname }}"
