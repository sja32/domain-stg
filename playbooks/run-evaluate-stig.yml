---
- name: Run Evaluate-STIG scan and upload results
  hosts: domain_controllers
  gather_facts: false

  vars:
    # Where the Evaluate-STIG script lives on the Windows host
    stig_script_path: "C:\\ProgramData\\Evaluate-STIG\\Evaluate-STIG.ps1"

    # Local results output directory on the Windows host
    stig_output_path: "C:\\ProgramData\\Evaluate-STIG\\Results"

    # Network SMB share to upload results to
    stig_results_smb_path: "192.168.10.50\\stig-results"

    # The role/group this Windows system represents
    role_name: "Windows-Server"

  tasks:

    ###################################################################
    # Ensure Evaluate-STIG.ps1 exists before running
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_script_path }}"
      register: stig_script_check

    - name: ❌ Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 is missing on {{ inventory_hostname }}. Run prep-stig-host first."
      when: not stig_script_check.stat.exists

    ###################################################################
    # Run Evaluate-STIG
    ###################################################################
    - name: ▶️ Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        powershell -NoLogo -NoProfile -ExecutionPolicy Bypass -File "{{ stig_script_path }}" -OutputPath "{{ stig_output_path }}"
      register: stig_scan_output
      changed_when: true

    ###################################################################
    # Generate timestamp on the Windows host
    ###################################################################
    - name: Generate timestamp on the Windows host
      ansible.windows.win_shell: |
        (Get-Date).ToString('yyyy-MM-dd_HH-mm')
      register: stig_timestamp_raw

    - name: Set timestamp fact
      set_fact:
        stig_timestamp: "{{ stig_timestamp_raw.stdout | trim }}"

    ###################################################################
    # Create timestamp folder on SMB share
    ###################################################################
    - name: Create timestamp results folder on SMB share
      ansible.windows.win_file:
        path: "\\\\{{ stig_results_smb_path }}\\{{ role_name }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}"
        state: directory

    ###################################################################
    # Copy results to SMB share
    ###################################################################
    - name: Upload STIG results to timestamped folder
      ansible.windows.win_copy:
        src: "{{ stig_output_path }}\\"
        dest: "\\\\{{ stig_results_smb_path }}\\{{ role_name }}\\{{ inventory_hostname }}\\{{ stig_timestamp }}\\"
        remote_src: yes

    ###################################################################
    # Completion message
    ###################################################################
    - name: ✅ Completed
      ansible.builtin.debug:
        msg: "STIG results uploaded: \\\\{{ stig_results_s
