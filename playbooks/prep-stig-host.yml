---
- name: Prepare Hosts for Evaluate-STIG
  hosts: domain_controllers
  gather_facts: no

  vars:
    stig_source_share: "\\\\192.168.10.198\\evaluate-stig\\Evaluate-STIG_1.2507.5"
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"

  tasks:

    - name: "ðŸš€ Banner - Start Host Prep"
      ansible.builtin.debug:
        msg: "Preparing {{ inventory_hostname }} for Evaluate-STIG"

    - name: Ensure local Evaluate-STIG folder exists
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: Copy Evaluate-STIG to ProgramData (UNC path, no drive mapping)
      ansible.windows.win_shell: |
        Copy-Item "{{ stig_source_share }}\\*" "{{ stig_local_path }}" -Recurse -Force
      args:
        executable: PowerShell.exe
      changed_when: true

    - name: Unblock Evaluate-STIG PowerShell scripts
      ansible.windows.win_shell: |
        Get-ChildItem -Path "{{ stig_local_path }}" -Recurse -Include *.ps1,*.psm1,*.psd1 | Unblock-File
      args:
        executable: PowerShell.exe

    - name: Import DoD Certificates
      ansible.windows.win_shell: |
        & "{{ stig_local_path }}\\Prerequisites\\Import-Certificates.bat"
      args:
        executable: PowerShell.exe

    - name: Verify WinRM responds to remote commands
      ansible.windows.win_shell: |
        Write-Output "WinRM is responding from $env:COMPUTERNAME"
      args:
        executable: PowerShell.exe
      register: winrm_check

    - debug:
        msg: "{{ winrm_check.stdout }}"

    - name: "âœ… Host prep complete"
      ansible.builtin.debug:
        msg: "Host is now ready to run Evaluate-STIG"
