---
- name: Prepare Hosts for Evaluate-STIG
  hosts: domain_controllers
  gather_facts: no

  vars:
    stig_share_eval: "\\\\192.168.10.198\\Evaluate-STIG"
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"

  tasks:

    - name: üöÄ Starting host preparation
      ansible.builtin.debug:
        msg: "Preparing {{ inventory_hostname }} for Evaluate-STIG"

    - name: Ensure ProgramData STIG directory exists
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: Map Evaluate-STIG share as Z:
      ansible.windows.win_shell: |
        net use Z: "{{ stig_share_eval }}" /user:voughtnet\svc-ansible "Luasi965!"
      args:
        executable: cmd.exe

    - name: Copy Evaluate-STIG to ProgramData
      ansible.windows.win_shell: |
        Copy-Item "Z:\{{ stig_version }}" "C:\ProgramData" -Recurse -Force
      args:
        executable: PowerShell.exe

    - name: ‚úÖ Verify Evaluate-STIG.ps1 exists locally
      ansible.windows.win_shell: |
        if (-not (Test-Path "{{ stig_local_path }}\\Evaluate-STIG.ps1")) {
            Write-Error "‚ùå Evaluate-STIG.ps1 missing in {{ stig_local_path }}. Copy failed."
        }
      args:
        executable: PowerShell.exe

    - name: Unblock all Evaluate-STIG PowerShell scripts
      ansible.windows.win_shell: |
        Get-ChildItem -Path "{{ stig_local_path }}" -Recurse -Include *.ps1,*.psm1,*.psd1 | Unblock-File
      args:
        executable: PowerShell.exe

    - name: Import Certificates (Prerequisites)
      ansible.windows.win_shell: |
        & "{{ stig_local_path }}\Prerequisites\Import-Certificates.bat"
      args:
        executable: PowerShell.exe

    - name: Remove Z: mapping
      ansible.windows.win_shell: |
        net use Z: /delete /y
      args:
        executable: cmd.exe

    - name: ‚úÖ Host prep complete
      ansible.builtin.debug:
        msg: "‚úÖ Host prep completed successfully on {{ inventory_hostname }}"
