---
- name: Copy Evaluate-STIG results to central share
  hosts: all
  gather_facts: no

  vars:
    stig_results_dir: stig_results_dir: "C:\\Users\\Public\\Documents\\STIG_Compliance\\{{ ansible_hostname }}\\Checklist"

    smb_share_root: "\\\\192.168.10.198\\stig-results"

    # Value comes from AWX group variable (Example: "Domain-Controllers")
    stig_role_folder: "{{ stig_role_folder | default('Uncategorized') }}"

  tasks:

    ###################################################################
    # Verify Checklist folder exists
    ###################################################################
    - name: Ensure host has a Checklist folder
      ansible.windows.win_stat:
        path: "{{ stig_results_dir }}"
      register: checklist_dir

    - name: ❌ Fail if no results exist yet
      ansible.builtin.fail:
        msg: "No STIG results exist on this host. Run scan first."
      when: not checklist_dir.stat.exists

    ###################################################################
    # Create timestamp for destination
    ###################################################################
    - name: Generate timestamp
      ansible.builtin.set_fact:
        copy_timestamp: "{{ lookup('pipe', 'powershell -NoLogo -NoProfile -Command \"(Get-Date).ToString(\\'yyyy-MM-dd_HH-mm\\')\"') }}"

    ###################################################################
    # Create destination folder structure on SMB share
    ###################################################################
    - name: Create destination folder structure on SMB share
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString '{{ smb_password }}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential('{{ smb_username }}', $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = "R:\\{{ stig_role_folder }}"
        $hostPath = "$rolePath\\{{ inventory_hostname }}"
        $timePath = "$hostPath\\{{ copy_timestamp }}"

        if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath | Out-Null }
        if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath | Out-Null }
        if (-not (Test-Path $timePath)) { New-Item -ItemType Directory -Path $timePath | Out-Null }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Copy files
    ###################################################################
    - name: Copy results to SMB share
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString '{{ smb_password }}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential('{{ smb_username }}', $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null

        Copy-Item "{{ stig_results_dir }}\\*" "R:\\{{ stig_role_folder }}\\{{ ansible_hostname }}\\{{ copy_timestamp }}" -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Completion Message
    ###################################################################
    - name: ✅ Summary
      debug:
        msg: >
          Results copied to
          {{ smb_share_root }}\{{ stig_role_folder }}\{{ inventory_hostname }}\{{ copy_timestamp }}
