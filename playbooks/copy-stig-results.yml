---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all
  gather_facts: yes

  vars:
    stig_results_path: "C:\\Users\\Public\\Documents\\STIG_Compliance\\Checklist"
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    # ---------------------------------------------------------
    # Verify Checklist directory exists
    # ---------------------------------------------------------
    - name: Verify Checklist directory exists
      ansible.windows.win_stat:
        path: "{{ stig_results_path }}"
      register: results_dir

    - name: "Stop if no results exist"
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results found. Run STIG scan first."
      when: not results_dir.stat.exists

    # ---------------------------------------------------------
    # Map STIG share as R:
    # ---------------------------------------------------------
    - name: "Map STIG share to R:"
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Create host folder if missing
    # ---------------------------------------------------------
    - name: "Ensure host folder exists on R:"
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ ansible_hostname }}")) {
          New-Item -ItemType Directory -Path "R:\\{{ ansible_hostname }}" | Out-Null
        }
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Copy results
    # ---------------------------------------------------------
    - name: "Copy STIG results to central share"
      ansible.windows.win_shell: |
        Copy-Item "{{ stig_results_path }}\\*" "R:\\{{ ansible_hostname }}" -Recurse -Force
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Unmap R:
    # ---------------------------------------------------------
    - name: "Unmap R:"
      ansible.windows.win_shell: |
        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: powershell.exe
      ignore_errors: yes
