---
- name: Copy Evaluate-STIG results to central share
  hosts: all
  gather_facts: yes  # we use ansible_hostname

  vars:
    # Where Evaluate-STIG writes results
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    checklist_path: "{{ stig_results_root }}\\{{ ansible_hostname }}\\Checklist"

    # Central share
    smb_share_root: "\\\\192.168.10.198\\stig-results"

    # Role folder (set this in AWX group vars per group)
    # e.g. for Domain Controllers group: stig_role_folder: "Domain-Controllers"
    stig_role_folder: "{{ stig_role_folder | default('Uncategorized') }}"

    # Timestamp for the destination
    timestamp: "{{ lookup('pipe', 'powershell -NoLogo -NoProfile -Command \"(Get-Date).ToString(\\'yyyy-MM-dd_HH-mm\\')\"') }}"

  tasks:
    - name: Ensure host has Checklist folder
      ansible.windows.win_stat:
        path: "{{ checklist_path }}"
      register: checklist_dir

    - name: ❌ Fail if no results exist yet
      ansible.builtin.fail:
        msg: "No STIG results exist on this host. Run scan first."
      when: not checklist_dir.stat.exists

    - name: Create destination directory on SMB share (Role -> Host -> Timestamp)
      ansible.windows.win_shell: |
        $sec  = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential -ArgumentList "{{ smb_username }}", $sec

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = "R:\{{ stig_role_folder }}"
        $hostPath = "$rolePath\{{ ansible_hostname }}"
        $timePath = "$hostPath\{{ timestamp }}"

        if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath | Out-Null }
        if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath | Out-Null }
        if (-not (Test-Path $timePath)) { New-Item -ItemType Directory -Path $timePath | Out-Null }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    - name: Copy Checklist files to timestamped folder
      ansible.windows.win_shell: |
        $sec  = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential -ArgumentList "{{ smb_username }}", $sec

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $src  = "{{ checklist_path }}"
        $dest = "R:\{{ stig_role_folder }}\{{ ansible_hostname }}\{{ timestamp }}"

        Copy-Item "$src\*" "$dest" -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    - name: ✅ Summary
      ansible.builtin.debug:
        msg:
          - "Results copied for {{ ansible_hostname }}"
          - "Destination: {{ smb_share_root }}\\{{ stig_role_folder }}\\{{ ansible_hostname }}\\{{ timestamp }}"
