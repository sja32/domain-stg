---
- name: Copy Evaluate-STIG results to central share
  hosts: all
  gather_facts: no
  vars:
    stig_results_source: "C:\\Users\\Public\\Documents\\STIG_Compliance\\$env:COMPUTERNAME\\Checklist"
    stig_results_dest: "\\\\192.168.10.198\\STIG-Results\\$env:COMPUTERNAME"

  tasks:

    - name: Verify Checklist directory exists
      ansible.windows.win_stat:
        path: "{{ stig_results_source }}"
      register: checklist_stat

    - name: Stop if no results exist
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results found in {{ stig_results_source }}. Run STIG scan first."
      when: not checklist_stat.stat.exists

    - name: Ensure target directory exists on SMB share
      ansible.windows.win_shell: |
        New-Item -ItemType Directory -Force -Path "{{ stig_results_dest }}"
      args:
        executable: powershell.exe

    - name: Map SMB share
      ansible.windows.win_shell: |
        net use {{ stig_results_dest }} /user:{{ smb_username }} "{{ smb_password }}"
      register: map_share
      changed_when: "'The command completed successfully' in map_share.stdout"
      args:
        executable: powershell.exe

    - name: Copy results (robocopy incremental sync)
      ansible.windows.win_shell: |
        robocopy "{{ stig_results_source }}" "{{ stig_results_dest }}" /E /Z /R:2 /W:1 /NFL /NDL
      args:
        executable: powershell.exe

    - name: Unmap SMB share
      ansible.windows.win_shell: |
        net use {{ stig_results_dest }} /delete /y
      ignore_errors: true
      args:
        executable: powershell.exe
