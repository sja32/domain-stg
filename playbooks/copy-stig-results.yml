---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all
  gather_facts: yes

  vars:
    # Where Evaluate-STIG actually stores results:
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance\\{{ ansible_hostname }}\\Checklist"

    # Your Windows network share:
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    # ---------------------------------------------------------
    # Verify results exist
    # ---------------------------------------------------------
    - name: Verify Checklist directory exists
      ansible.windows.win_stat:
        path: "{{ stig_results_local }}"
      register: checklist_dir

    - name: Stop if no results exist
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results found on {{ ansible_hostname }}. Run STIG scan first."
      when: not checklist_dir.stat.exists

    # ---------------------------------------------------------
    # Map share as R: using AWX SMB credential
    # ---------------------------------------------------------
    - name: Map STIG share to R:
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Ensure host folder exists on share
    # ---------------------------------------------------------
    - name: Ensure host directory exists on share
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ ansible_hostname }}")) {
            New-Item -ItemType Directory -Path "R:\\{{ ansible_hostname }}" | Out-Null
        }
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Copy all CKL + CSV files
    # ---------------------------------------------------------
    - name: Copy STIG results to share
      ansible.windows.win_shell: |
        Copy-Item "{{ stig_results_local }}\\*" "R:\\{{ ansible_hostname }}" -Recurse -Force
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Unmount drive cleanly, ignore failures
    # ---------------------------------------------------------
    - name: Unmap R:
      ansible.windows.win_shell: |
        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: powershell.exe
      ignore_errors: yes

    - name: âœ… Summary
      debug:
        msg:
          - "âœ… Results copied successfully for {{ ansible_hostname }}"
          - "ðŸ“¤ Destination: {{ stig_share_root }}\\{{ ansible_hostname }}"
