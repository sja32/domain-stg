---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all
  gather_facts: yes

  vars:
    # Local results location created by Evaluate-STIG
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance\\Checklist"

    # Central file server share root (your Windows share)
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"

    # These two come from your AWX custom credential:
    # smb_user â†’ voughtnet\svc-ansible
    # smb_pass â†’ password (masked)
    # Do NOT modify here.

  tasks:

    # ---------------------------------------------------------
    # Validate local results exist
    # ---------------------------------------------------------
    - name: "Verify Checklist directory exists"
      ansible.windows.win_stat:
        path: "{{ stig_results_local }}"
      register: results_dir

    - name: "Stop if no results exist"
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results found. Run STIG scan first."
      when: not results_dir.stat.exists

    # ---------------------------------------------------------
    # Map SMB share as R:
    # ---------------------------------------------------------
    - name: "Map STIG share as R: using domain credentials"
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Ensure host folder exists on share
    # Example path created:
    #   R:\WINDC2
    # ---------------------------------------------------------
    - name: "Ensure host folder exists on R:"
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ ansible_hostname }}")) {
            New-Item -ItemType Directory -Path "R:\\{{ ansible_hostname }}" | Out-Null
        }
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Copy STIG results (CKL + CSV files) to central share
    # ---------------------------------------------------------
    - name: "Copy STIG results to central share"
      ansible.windows.win_shell: |
        Copy-Item "{{ stig_results_local }}\\*" "R:\\{{ ansible_hostname }}" -Recurse -Force
      args:
        executable: powershell.exe

    # ---------------------------------------------------------
    # Unmount R: (ignore errors so playbook does not fail)
    # ---------------------------------------------------------
    - name: "Unmount R: drive"
      ansible.windows.win_shell: |
        if (Get-PSDrive R -ErrorAction SilentlyContinue) {
            Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
        }
      args:
        executable: powershell.exe
      ignore_errors: yes

    # ---------------------------------------------------------
    # Summary
    # ---------------------------------------------------------
    - name: âœ… Summary
      debug:
        msg:
          - "âœ… Results copied for {{ ansible_hostname }}"
          - "ðŸ“¤ Destination: {{ stig_share_root }}\\{{ ansible_hostname }}"
