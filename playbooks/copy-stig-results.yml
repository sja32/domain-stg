---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all          # scope this to your 'domain_controllers' group in the template
  gather_facts: yes

  vars:
    # Local path where Evaluate-STIG writes results
    stig_results_root: 'C:\Users\Public\Documents\STIG_Compliance'

    # Your Windows file server share (NOT Synology)
    share_root: '\\192.168.10.198\STIG-Results'

    # Folder on the share for this role (you set this in group vars already)
    role_folder: "{{ stig_role_folder | default('Domain-Controllers') }}"

    # Support either set of injected var names from the AWX credential
    smb_user_effective: "{{ smb_user | default(smb_username) }}"
    smb_pass_effective: "{{ smb_pass | default(smb_password) }}"

    # PowerShell block that does the whole job
    ps_map_and_copy: |
      $srcRoot = '{{ stig_results_root }}'
      $hostName = $env:COMPUTERNAME
      $src = Join-Path -Path $srcRoot -ChildPath $hostName
      $srcChecklist = Join-Path -Path $src -ChildPath 'Checklist'

      if (-not (Test-Path -Path $srcChecklist)) {
        throw "No Evaluate-STIG results at $srcChecklist"
      }

      # Map PSDrive 'R:' to the Windows share using provided domain creds
      $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
      $cred = New-Object System.Management.Automation.PSCredential -ArgumentList '{{ smb_user_effective }}', $sec
      New-PSDrive -Name 'R' -PSProvider FileSystem -Root '{{ share_root }}' -Credential $cred -ErrorAction Stop | Out-Null

      # Ensure R:\<role_folder>\<HOSTNAME> exists
      $rolePath  = Join-Path -Path 'R:\' -ChildPath '{{ role_folder }}'
      $destHost  = Join-Path -Path $rolePath -ChildPath $hostName
      if (-not (Test-Path -Path $rolePath))  { New-Item -ItemType Directory -Path $rolePath -Force  | Out-Null }
      if (-not (Test-Path -Path $destHost))  { New-Item -ItemType Directory -Path $destHost -Force  | Out-Null }

      # Copy everything from Checklist
      Copy-Item -Path (Join-Path $src 'Checklist\*') -Destination $destHost -Recurse -Force

      'Copied to ' + $destHost

  tasks:
    - name: Copy results to central share
      ansible.windows.win_shell: "{{ ps_map_and_copy }}"
      args:
        executable: PowerShell.exe

    - name: Show destination
      debug:
        msg: "Results copied to {{ share_root }}\\{{ role_folder }}\\{{ ansible_env.COMPUTERNAME }}"
