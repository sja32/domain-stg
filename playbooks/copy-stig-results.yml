# ---------------------------------------------------------
# Map share as R: using AWX SMB credential
# ---------------------------------------------------------
- name: "Map STIG share to R:"
  ansible.windows.win_shell: |
    $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
    $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)
    New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
  args:
    executable: powershell.exe

# ---------------------------------------------------------
# Ensure host folder exists on share
# ---------------------------------------------------------
- name: "Ensure host folder exists on R:"
  ansible.windows.win_shell: |
    if (-not (Test-Path "R:\\{{ ansible_hostname }}")) {
        New-Item -ItemType Directory -Path "R:\\{{ ansible_hostname }}" | Out-Null
    }
  args:
    executable: powershell.exe

# ---------------------------------------------------------
# Unmount drive cleanly
# ---------------------------------------------------------
- name: "Unmap R:"
  ansible.windows.win_shell: |
    Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
  args:
    executable: powershell.exe
  ignore_errors: yes
