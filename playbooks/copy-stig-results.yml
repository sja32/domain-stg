---
- name: Copy latest Evaluate-STIG results to central share
  hosts: all
  gather_facts: no

  vars:
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\stig-results"
    stig_role_folder: "{{ stig_role_folder | default('Uncategorized') }}"

  tasks:

    # --------------------------------------------------------------
    # Identify the latest timestamp folder under host results
    # --------------------------------------------------------------
    - name: Identify latest timestamp directory
      ansible.windows.win_shell: |
        Get-ChildItem "{{ stig_results_root }}\\{{ inventory_hostname }}" -Directory |
        Sort-Object Name -Descending |
        Select-Object -First 1 |
        Select-Object -ExpandProperty Name
      args:
        executable: powershell.exe
      register: timestamp_result
      changed_when: false

    - name: Fail if timestamp directory not found
      ansible.builtin.fail:
        msg: "No results found for this host. Run STIG scan first."
      when: ti
