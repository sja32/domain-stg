---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all
  gather_facts: no

  vars:
    stig_results_source: "C:\\Users\\Public\\Documents\\STIG_Compliance\\$env:COMPUTERNAME\\Checklist"
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"
    smb_user: "{{ smb_username }}"      # From SMB credential
    smb_pass: "{{ smb_password }}"      # From SMB credential

  tasks:

    - name: Verify Checklist directory exists
      ansible.windows.win_stat:
        path: "{{ stig_results_source }}"
      register: results_dir

    - name: Stop if no results exist
      fail:
        msg: "No Evaluate-STIG results found. Run scan first."
      when: not results_dir.stat.exists

    - name: Map STIG share as R:
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    - name: Ensure role folder exists (e.g., Domain-Controllers)
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ stig_role_folder }}")) {
            New-Item -ItemType Directory -Path "R:\\{{ stig_role_folder }}" | Out-Null
        }
      args:
        executable: powershell.exe

    - name: Ensure host folder exists under role folder
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ stig_role_folder }}\\$env:COMPUTERNAME")) {
            New-Item -ItemType Directory -Path "R:\\{{ stig_role_folder }}\\$env:COMPUTERNAME" | Out-Null
        }
      args:
        executable: powershell.exe

    - name: Copy STIG results
      ansible.windows.win_shell: |
        Copy-Item "{{ stig_results_source }}\\*" "R:\\{{ stig_role_folder }}\\$env:COMPUTERNAME" -Recurse -Force
      args:
        executable: powershell.exe

    - name: Unmount R:
      ansible.windows.win_shell: |
        if (Get-PSDrive R -ErrorAction SilentlyContinue) {
            Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
        }
      args:
        executable: powershell.exe
      ignore_errors: yes
