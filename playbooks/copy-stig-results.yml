---
- name: Copy Evaluate-STIG results to central share
  hosts: all
  gather_facts: yes

  vars:
    stig_results_source: "C:\\Users\\Public\\Documents\\STIG_Compliance\\{{ ansible_hostname }}\\Checklist"
    stig_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    - name: "Verify Checklist directory exists"
      ansible.windows.win_stat:
        path: "{{ stig_results_source }}"
      register: checklist_stat

    - name: "Stop if no results exist"
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results found in {{ stig_results_source }}. Run STIG scan first."
      when: not checklist_stat.stat.exists

    - name: "Map SMB share as R:"
      ansible.windows.win_shell: |
        net use R: "{{ stig_share_root }}" /user:"{{ smb_username }}" "{{ smb_password }}" /persistent:no
      args:
        executable: powershell.exe

    - name: "Ensure host folder exists on R:"
      ansible.windows.win_shell: |
        if (-not (Test-Path "R:\\{{ ansible_hostname }}")) {
          New-Item -ItemType Directory -Path "R:\\{{ ansible_hostname }}" | Out-Null
        }
      args:
        executable: powershell.exe

    - name: "Copy results into share"
      ansible.windows.win_shell: |
        Copy-Item -Path "{{ stig_results_source }}\\*" -Destination "R:\\{{ ansible_hostname }}" -Recurse -Force
      args:
        executable: powershell.exe

    - name: "Unmap R:"
      ansible.windows.win_shell: |
        net use R: /delete /y
      ignore_errors: true
      args:
        executable: powershell.exe
