---
- name: Copy Evaluate-STIG results to central share (Domain Environment)
  hosts: all
  gather_facts: no

  vars:
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\stig-results"
    stig_role_folder: "{{ stig_role_folder | default('Uncategorized') }}"

  tasks:

    ###################################################################
    # Get latest timestamp folder from STIG_Compliance
    ###################################################################
    - name: Identify latest timestamp results folder
      ansible.windows.win_shell: |
        $latest = Get-ChildItem "{{ stig_results }}" -Directory |
                  Sort-Object LastWriteTime -Descending |
                  Select-Object -First 1 |
                  Select-Object -ExpandProperty Name
        Write-Output $latest
      args:
        executable: PowerShell.exe
      register: timestamp_raw

    - name: Store timestamp fact
      set_fact:
        timestamp: "{{ timestamp_raw.stdout | trim }}"

    - name: Fail if scan has not yet been run
      fail:
        msg: "No timestamped results exist. Run the Evaluate-STIG scan playbook first."
      when: timestamp == ""

    ###################################################################
    # Create Role -> Host -> Timestamp path on share
    ###################################################################
    - name: Create SMB directory structure
      ansible.windows.win_shell: |
        $sec  = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = "R:\{{ stig_role_folder }}"
        $hostPath = "$rolePath\{{ inventory_hostname }}"
        $timePath = "$hostPath\{{ timestamp }}"

        if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath | Out-Null }
        if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath | Out-Null }
        if (-not (Test-Path $timePath)) { New-Item -ItemType Directory -Path $timePath | Out-Null }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Copy only the latest run folder
    ###################################################################
    - name: Copy latest STIG results to share
      ansible.windows.win_shell: |
        $sec  = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $src  = "{{ stig_results }}\{{ timestamp }}\*"
        $dest = "R:\{{ stig_role_folder }}\{{ inventory_hostname }}\{{ timestamp }}"

        Copy-Item $src $dest -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # Summary
    ###################################################################
    - name: ‚úÖ Summary
      debug:
        msg:
          - "üì§ Copied STIG results from {{ inventory_hostname }}"
          - "‚û°Ô∏è  {{ smb_share_root }}\\{{ stig_role_folder }}\\{{ inventory_hostname }}\\{{ timestamp }}"
