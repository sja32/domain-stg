---
- name: Copy Evaluate-STIG results to central Windows share
  hosts: all
  gather_facts: no

  vars:
    stig_results_source: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    stig_results_share: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    - name: Ensure STIG results folder exists locally
      ansible.windows.win_stat:
        path: "{{ stig_results_source }}"
      register: stig_local

    - name: Stop if STIG results do not exist
      ansible.builtin.fail:
        msg: "No Evaluate-STIG results exist. Run STIG scan first."
      when: not stig_local.stat.exists

    - name: Map SMB share as R: using domain credentials
      ansible.windows.win_shell: |
        $sec = ConvertTo-SecureString '{{ smb_password }}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_username }}', $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root '{{ stig_results_share }}' -Credential $cred -ErrorAction Stop | Out-Null
      args:
        executable: powershell.exe

    - name: Copy entire STIG_Compliance folder using PowerShell Copy-Item
      ansible.windows.win_shell: |
        $hostname = $env:COMPUTERNAME
        $dest = "R:\\$hostname"

        if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest | Out-Null
        }

        Copy-Item -Path "{{ stig_results_source }}\\*" -Destination $dest -Recurse -Force
      args:
        executable: powershell.exe

    - name: Unmap R: cleanly
      ansible.windows.win_shell: |
        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: powershell.exe
      ignore_errors: yes
