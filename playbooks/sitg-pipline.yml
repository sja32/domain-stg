---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no

  vars:
    stig_script: "C:\\ProgramData\\{{ stig_version }}\\Evaluate-STIG.ps1"
    results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    share_root: "\\\\192.168.10.198\\stig-results"

  tasks:
    ###################################################################
    # Confirm Evaluate-STIG script is present
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_script }}"
      register: stig_file

    - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 is missing. Run the prep playbook first."
      when: not stig_file.stat.exists

    ###################################################################
    # Run the Evaluate-STIG scan (CKL + CSV output)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "C:\\ProgramData\\{{ stig_version }}"
        .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV"
      args:
        executable: PowerShell.exe

    ###################################################################
    # Determine correct group-name path from inventory
    ###################################################################
    - name: Determine group name for this host
      set_fact:
        group_name: "{{ group_names[0] }}"

    - name: Convert group name for folder naming
      set_fact:
        group_folder: "{{ group_name | lower | replace('_','-') }}"

    ###################################################################
    # Create \\share\<role>\<hostname> and upload
    ###################################################################
    - name: Ensure SMB destination folder exists
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          $rolePath = "R:\\{{ group_folder }}"
          $hostPath = "$rolePath\\{{ inventory_hostname }}"

          if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }
          if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath -Force | Out-Null }

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    - name: üì§ Copy STIG results to SMB share
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          $src = "{{ results_local }}\\{{ inventory_hostname }}"
          $dst = "R:\\{{ group_folder }}\\{{ inventory_hostname }}"

          if (Test-Path $src) {
            Copy-Item -Path "$src\\*" -Destination $dst -Recurse -Force
          }

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    ###################################################################
    # Summary
    ###################################################################
    - name: ‚úÖ Summary
      ansible.builtin.debug:
        msg:
          - "‚úÖ STIG Scan completed on {{ inventory_hostname }}"
          - "üì§ Uploaded to: {{ share_root }}\\{{ group_folder }}\\{{ inventory_hostname }}"
