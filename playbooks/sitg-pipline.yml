---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no

  vars:
    # Evaluate-STIG Installation Folder
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_workdir: "C:\\ProgramData\\{{ stig_version }}"

    # Where Evaluate-STIG writes results by default
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # Root of SMB Share (do NOT change formatting)
    smb_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    ###################################################################
    # Ensure Evaluate-STIG is present
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
      register: stig_ps1

    - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 not found ‚Äî run prep first."
      when: not stig_ps1.stat.exists

    ###################################################################
    # Run Evaluate-STIG (test mode uses dotnet4 only to save time)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV"
      args:
        executable: PowerShell.exe

    ###################################################################
    # Determine the group name for folder placement
    ###################################################################
    - name: Determine group name for this host
      set_fact:
        host_role: "{{ group_names[0] }}"

    - name: Convert group name to lowercase + hyphens
      set_fact:
        host_role_normalized: "{{ host_role | lower | regex_replace('_', '-') | regex_replace(' ', '-') }}"

    ###################################################################
    # Copy ENTIRE HOST RESULTS FOLDER to SMB Share (K.I.S.F.)
    ###################################################################
    - name: üì§ Copy STIG results to SMB share
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)

          # Mount Share
          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          # Hostname without domain
          $host = "{{ inventory_hostname.split('.')[0] }}"
          $role = "{{ host_role_normalized }}"
          $source = "{{ stig_results_root }}\\$host"
          $dest = "R:\\$role\\$host"

          # Ensure destination folder exists
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }

          # Copy entire results folder (K.I.S.F.)
          Copy-Item $source\* $dest -Recurse -Force -ErrorAction Stop

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe

    ###################################################################
    # ‚úÖ Summary
    ###################################################################
    - name: ‚úÖ Summary
      debug:
        msg:
          - "‚úÖ STIG Scan completed on {{ inventory_hostname }}"
          - "üì§ Results uploaded to: {{ smb_share_root }}\\{{ host_role_normalized }}\\{{ inventory_hostname.split('.')[0] }}"
