---
- name: Full STIG Pipeline (Prep ‚Üí Scan ‚Üí Upload)
  hosts: all
  gather_facts: no

  vars:
    # Version & paths
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_share_path: "\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance"

  tasks:
  ###################################################################
  # 1) Prep - Ensure Evaluate-STIG is deployed fresh each run
  ###################################################################
  - name: üöÄ Prep - Remove existing Evaluate-STIG directory
    ansible.windows.win_powershell:
      script: |
        if (Test-Path "{{ stig_local_path }}") {
            Remove-Item "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
        }

  - name: Create Evaluate-STIG directory
    ansible.windows.win_file:
      path: "{{ stig_local_path }}"
      state: directory

  - name: Copy Evaluate-STIG to host (fresh deployment)
    ansible.windows.win_powershell:
      script: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_path }}" -Credential $cred -ErrorAction Stop | Out-Null
        Copy-Item "Z:\*" "{{ stig_local_path }}" -Recurse -Force
        Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

  ###################################################################
  # 2) Run the STIG Scan (dotnet4 targeted for speed)
  ###################################################################
  - name: ‚ñ∂Ô∏è Run Evaluate-STIG Scan (dotnet4 only)
    ansible.windows.win_shell: |
      Set-ExecutionPolicy Bypass -Scope Process -Force
      Set-Location "{{ stig_local_path }}"
      .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV"
    args:
      executable: PowerShell.exe

  - name: ‚úÖ Scan Completed
    ansible.builtin.debug:
      msg: "STIG Scan complete on {{ inventory_hostname }}"

  ###################################################################
  # 3) Determine group name for correct share folder
  ###################################################################
  - name: Determine inventory group name for results directory
    set_fact:
      stig_results_role: "{{ group_names[0] }}"

  ###################################################################
  # 4) Copy Results Folder (exact folder name preserved)
  ###################################################################
  - name: üì§ Copy STIG results to SMB share (no rename)
    ansible.windows.win_powershell:
      script: |
        $localRoot = "{{ stig_results_local }}"
        $hostnameFolder = (Get-ChildItem $localRoot | Where-Object { $_.PSIsContainer }).Name
        $localPath = Join-Path $localRoot $hostnameFolder

        $roleFolder = "{{ stig_results_role }}"
        $shareRoot = "\\192.168.10.198\STIG-Results\$roleFolder"

        $sec = ConvertTo-SecureString "{{ SMB_PASSWORD }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ SMB_USERNAME }}", $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root "\\192.168.10.198\STIG-Results" -Credential $cred -ErrorAction Stop | Out-Null

        if (!(Test-Path "R:\$roleFolder")) {
          New-Item -ItemType Directory -Path "R:\$roleFolder" -Force | Out-Null
        }

        Copy-Item "$localPath" "R:\$roleFolder" -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

  ###################################################################
  # 5) Summary Output
  ###################################################################
  - name: ‚úÖ Summary
    ansible.builtin.debug:
      msg:
        - "Completed on: {{ inventory_hostname }}"
        - "Local Source: {{ stig_results_local }}"
        - "Uploaded to: \\192.168.10.198\\STIG-Results\\{{ stig_results_role }}"
