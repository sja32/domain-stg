---
- name: Full STIG Pipeline (Prep ‚Üí Scan ‚Üí Upload)
  hosts: all
  gather_facts: no

  vars:
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_local_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    select_stig: "dotnet4"   # change if you want a different one

  tasks:

  ###################################################################
  # PREP: Always refresh Evaluate-STIG deployment
  ###################################################################
  - name: üöÄ Remove existing Evaluate-STIG directory
    ansible.windows.win_powershell:
      script: |
        if (Test-Path "{{ stig_local_path }}") {
            Remove-Item "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
        }

  - name: Create Evaluate-STIG directory
    ansible.windows.win_file:
      path: "{{ stig_local_path }}"
      state: directory

  - name: Copy Evaluate-STIG to host (fresh deployment)
    ansible.windows.win_powershell:
      script: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_path }}" -Credential $cred -ErrorAction Stop | Out-Null
        Copy-Item "Z:\*" "{{ stig_local_path }}" -Recurse -Force
        Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

  ###################################################################
  # RUN SCAN
  ###################################################################
  - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
    ansible.windows.win_shell: |
      Set-ExecutionPolicy Bypass -Scope Process -Force
      Set-Location "{{ stig_local_path }}"
      .\Evaluate-STIG.ps1 -selectstig {{ select_stig }} -Output "CKL,CSV"
    args:
      executable: PowerShell.exe

  - name: ‚úÖ Scan Done
    ansible.builtin.debug:
      msg: "‚úÖ STIG Scan complete on {{ inventory_hostname }}"

  ###################################################################
  # DETERMINE DESTINATION FOLDER BASED ON INVENTORY GROUP
  ###################################################################
  - name: Determine primary group for upload path
    ansible.builtin.set_fact:
      stig_role: "{{ group_names | difference(['all']) | first | lower }}"

  ###################################################################
  # COPY RESULTS TO SHARE
  ###################################################################
  - name: üì§ Copy STIG Results to SMB Share
    ansible.windows.win_powershell:
      script: |
        $sec = ConvertTo-SecureString "{{ SMB_PASSWORD }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ SMB_USERNAME }}", $sec)

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_results_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $src = "{{ stig_results_local_root }}\\{{ inventory_hostname }}"
        $dest = "R:\\{{ stig_role }}\\{{ inventory_hostname }}"

        if (Test-Path $src) {
            Copy-Item $src $dest -Recurse -Force
        }

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

  ###################################################################
  # SUMMARY
  ###################################################################
  - name: üèÅ Summary
    ansible.builtin.debug:
      msg:
        - "Completed on: {{ inventory_hostname }}"
        - "Source: {{ stig_results_local_root }}\\{{ inventory_hostname }}"
        - "Uploaded to: {{ stig_results_share_root }}\\{{ stig_role }}\\{{ inventory_hostname }}"
