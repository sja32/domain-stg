---
- name: Full STIG Pipeline (Prep → Scan → Copy)
  hosts: all
  gather_facts: no

  vars:
    stig_share_source: "\\\\192.168.10.198\\Evaluate-STIG"
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5"
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance\\{{ inventory_hostname }}\\Checklist"
    smb_share_root: "\\\\192.168.10.198\\stig-results"

  tasks:

    ###################################################################
    # 1) PREP HOST FOR EVALUATE-STIG
    ###################################################################
    - name: Ensure STIG working directory exists
      ansible.windows.win_file:
        path: "{{ stig_workdir }}"
        state: directory

    - name: Ensure STIG results folder exists
      ansible.windows.win_file:
        path: "C:\\Users\\Public\\Documents\\STIG_Compliance"
        state: directory

    - name: Copy Evaluate-STIG tool from SMB share if missing
      ansible.windows.win_shell: |
        if (-not (Test-Path "{{ stig_workdir }}\\Evaluate-STIG.ps1")) {
            $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
            $cred = New-Object System.Management.Automation.PSCredential -ArgumentList "{{ ansible_user }}", $sec

            New-PSDrive -Name X -PSProvider FileSystem -Root "{{ stig_share_source }}" -Credential $cred -ErrorAction Stop | Out-Null
            Copy-Item "X:\\*" "{{ stig_workdir }}" -Recurse -Force
            Remove-PSDrive -Name X -Force -ErrorAction SilentlyContinue
        }
      args:
        executable: PowerShell.exe
      no_log: true

    ###################################################################
    # 2) RUN EVALUATE-STIG SCAN
    ###################################################################
    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
      register: stig_ps1

    - name: ❌ Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 not found — prep stage failed."
      when: not stig_ps1.stat.exists

    - name: ▶️ Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -Output CKL,CSV
      args:
        executable: PowerShell.exe

    ##################################
