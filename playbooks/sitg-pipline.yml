---
- name: Full STIG Pipeline (Prep â†’ Scan â†’ Upload)
  hosts: all
  gather_facts: yes   # <â€” required so $env:COMPUTERNAME resolves cleanly

  vars:
    stig_version: Evaluate-STIG_1.2507.5
    stig_share_path: "\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    share_root: "\\192.168.10.198\\STIG-Results"

    # Map group to destination folder
    # (this works because your inventory is grouped properly)
    role_folder: "{{ group_names[0] }}"

    smb_user_effective: "{{ smb_user | default(smb_username) }}"
    smb_pass_effective: "{{ smb_pass | default(smb_password) }}"

  tasks:

  ###################################################################
  # PREP: Recopy Evaluate-STIG every run (always clean)
  ###################################################################
  - name: ðŸš€ Remove existing Evaluate-STIG directory
    ansible.windows.win_powershell:
      script: |
        if (Test-Path "{{ stig_local_path }}") {
          Remove-Item "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
        }

  - name: Create Evaluate-STIG directory
    ansible.windows.win_file:
      path: "{{ stig_local_path }}"
      state: directory

  - name: Copy Evaluate-STIG to host (fresh deployment)
    ansible.windows.win_powershell:
      script: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_path }}" -Credential $cred -ErrorAction Stop | Out-Null
        Copy-Item "Z:\*" "{{ stig_local_path }}" -Recurse -Force
        Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

  ###################################################################
  # RUN SCAN
  ###################################################################
  - name: â–¶ï¸ Run Evaluate-STIG scan (CKL + CSV)
    ansible.windows.win_shell: |
      Set-ExecutionPolicy Bypass -Scope Process -Force
      Set-Location "{{ stig_local_path }}"
      .\Evaluate-STIG.ps1 -SelectStig dotnet4 -Output "CKL,CSV"
    args:
      executable: PowerShell.exe

  - name: âœ… Scan Done
    debug:
      msg: "âœ… STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
  # COPY RESULTS TO SHARE (simple, correct, reliable)
  ###################################################################
  - name: ðŸ“¤ Copy STIG Results to SMB Share
    ansible.windows.win_powershell:
      script: |
        $srcRoot = "{{ stig_results_local }}"
        $hostName = $env:COMPUTERNAME
        $src = Join-Path -Path $srcRoot -ChildPath $hostName

        if (-not (Test-Path -Path $src)) {
            throw "âŒ No STIG results found in $src. Run Evaluate-STIG first."
        }

        $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)

        # Map drive to stig-results share
        New-PSDrive -Name R -PSProvider FileSystem -Root "\\\\192.168.10.198\\stig-results" -Credential $cred -ErrorAction Stop | Out-Null

        # Create host folder under share: R:\<hostname>
        $dest = "R:\\$hostName"
        if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
        }

        # Copy only the Checklist folder contents
        Copy-Item -Path "$src\\Checklist\\*" -Destination $dest -Recurse -Force

        # Unmap drive
        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

        "âœ… Results copied to $dest"

    register: copy_results_output

  - name: âœ… Show Upload Result
    debug:
      var: copy_results_output.stdout
