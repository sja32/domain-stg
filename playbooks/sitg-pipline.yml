---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no

  vars:
    # Evaluate-STIG install folder
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_workdir: "C:\\ProgramData\\{{ stig_version }}"

    # Where Evaluate-STIG stores results
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance\\{{ inventory_hostname }}\\Checklist"

    # SMB results share (already renamed to the lowercase version)
    stig_share_results: "\\\\192.168.10.198\\stig-results"

    # SMB credential (AWX credential injected)
    smb_username: "{{ lookup('env', 'SMB_USERNAME') | default('VoughtNet\\svc-ansible') }}"
    smb_password: "{{ lookup('env', 'SMB_PASSWORD') }}"

  tasks:

  ###################################################################
  # Ensure Evaluate-STIG.ps1 Exists
  ###################################################################
  - name: Ensure Evaluate-STIG.ps1 exists
    ansible.windows.win_stat:
      path: "{{ stig_workdir }}\\Evaluate-STIG.ps1"
    register: stig_ps1

  - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
    ansible.builtin.fail:
      msg: "Evaluate-STIG.ps1 not found ‚Äî run Prep first."
    when: not stig_ps1.stat.exists

  ###################################################################
  # Run Evaluate-STIG (uses default output)
  ###################################################################
  - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
    ansible.windows.win_shell: |
      Write-Host "Running Evaluate-STIG..."
      Set-Location "{{ stig_workdir }}"
      .\Evaluate-STIG.ps1 -Output "CKL,CSV"
      Write-Host "‚úÖ STIG scan complete."
    args:
      executable: PowerShell.exe

  ###################################################################
  # Create \\Share\<Role>\<Hostname>
  ###################################################################
  - name: Ensure SMB destination folder exists
    ansible.windows.win_shell: |
      $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
      $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)

      New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_results }}" -Credential $cred -ErrorAction Stop | Out-Null

      $rolePath = "R:\\{{ group_names[0] }}"
      $hostPath = "$rolePath\\{{ inventory_hostname }}"

      if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }
      if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath -Force | Out-Null }

      Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
    args:
      executable: PowerShell.exe

  ###################################################################
  # Upload Results (Overwrite / Update ‚Äî No Timestamp)
  ###################################################################
  - name: üì§ Copy STIG results to SMB share
    ansible.windows.win_shell: |
      $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
      $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_username }}", $sec)

      New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_results }}" -Credential $cred -ErrorAction Stop | Out-Null

      Copy-Item "{{ stig_results_local }}\\*" "R:\\{{ group_names[0] }}\\{{ inventory_hostname }}" -Recurse -Force

      Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
    args:
      executable: PowerShell.exe

  ###################################################################
  # Summary
  ###################################################################
  - name: ‚úÖ Summary
    debug:
      msg:
        - "‚úÖ STIG Scan completed on {{ inventory_hostname }}"
        - "üìÅ Local results: {{ stig_results_local }}"
        - "üì§ Uploaded to: {{ stig_share_results }}\\{{ group_names[0] }}\\{{ inventory_hostname }}"
