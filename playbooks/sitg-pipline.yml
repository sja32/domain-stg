---
- name: Full STIG Pipeline (Prep â†’ Scan â†’ Upload)
  hosts: all
  gather_facts: yes   # <â€” required so $env:COMPUTERNAME resolves cleanly

  vars:
    stig_version: Evaluate-STIG_1.2507.5
    stig_share_path: "\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    share_root: "\\192.168.10.198\\STIG-Results"

    # Map group to destination folder
    # (this works because your inventory is grouped properly)
    role_folder: "{{ group_names[0] }}"

    smb_user_effective: "{{ smb_user | default(smb_username) }}"
    smb_pass_effective: "{{ smb_pass | default(smb_password) }}"

  tasks:

  ###################################################################
  # PREP: Recopy Evaluate-STIG every run (always clean)
  ###################################################################
  - name: ðŸš€ Remove existing Evaluate-STIG directory
    ansible.windows.win_powershell:
      script: |
        if (Test-Path "{{ stig_local_path }}") {
          Remove-Item "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
        }

  - name: Create Evaluate-STIG directory
    ansible.windows.win_file:
      path: "{{ stig_local_path }}"
      state: directory

  - name: Copy Evaluate-STIG to host (fresh deployment)
    ansible.windows.win_powershell:
      script: |
        $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_path }}" -Credential $cred -ErrorAction Stop | Out-Null
        Copy-Item "Z:\*" "{{ stig_local_path }}" -Recurse -Force
        Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

  ###################################################################
  # RUN SCAN
  ###################################################################
  - name: â–¶ï¸ Run Evaluate-STIG scan (CKL + CSV)
    ansible.windows.win_shell: |
      Set-ExecutionPolicy Bypass -Scope Process -Force
      Set-Location "{{ stig_local_path }}"
      .\Evaluate-STIG.ps1 -SelectStig dotnet4 -Output "CKL,CSV"
    args:
      executable: PowerShell.exe

  - name: âœ… Scan Done
    debug:
      msg: "âœ… STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
  # COPY RESULTS TO SHARE
  ###################################################################
  - name: ðŸ“¤ Copy STIG Results to SMB Share
    ansible.windows.win_powershell:
      script: |
        $srcRoot    = "{{ stig_results_local }}"
        $hostName   = $env:COMPUTERNAME
        $src        = Join-Path -Path $srcRoot -ChildPath $hostName
        $srcChecklist = Join-Path -Path $src -ChildPath "Checklist"

        if (-not (Test-Path -Path $srcChecklist)) {
          throw "âŒ No Evaluate-STIG results found at $srcChecklist"
        }

        $sec  = ConvertTo-SecureString "{{ smb_pass_effective }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential "{{ smb_user_effective }}", $sec

        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $rolePath = Join-Path -Path "R:\" -ChildPath "{{ group_names[0] }}"
        $destHost = Join-Path -Path $rolePath -ChildPath $hostName

        if (-not (Test-Path -Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }
        if (-not (Test-Path -Path $destHost)) { New-Item -ItemType Directory -Path $destHost -Force | Out-Null }

        Copy-Item -Path (Join-Path $src "Checklist\*") -Destination $destHost -Recurse -Force

        Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    register: copy_result

  - name: âœ… Upload Complete
    debug:
      msg: "âœ… Results uploaded to {{ share_root }}\\{{ group_names[0] }}\\{{ ansible_hostname }}"
