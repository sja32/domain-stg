---
- name: Run Evaluate-STIG scan and upload results
  hosts: all
  gather_facts: no
  vars:
    share_path: "\\\\192.168.10.198\\STIG-Results"
    smb_user: "VoughtNet\\svc-ansible"
    smb_password: "Luasi965!"

  tasks:

    - name: Ensure Evaluate-STIG.ps1 exists
      ansible.windows.win_stat:
        path: 'C:\ProgramData\Evaluate-STIG\Evaluate-STIG.ps1'
      register: stig_script_check

    - name: ‚ùå Fail if Evaluate-STIG.ps1 is missing
      ansible.builtin.fail:
        msg: "Evaluate-STIG.ps1 is missing on {{ inventory_hostname }}. Run prep-stig-host first."
      when: not stig_script_check.stat.exists

    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        C:\ProgramData\Evaluate-STIG\Evaluate-STIG.ps1 `
          -output ckl, csv
      args:
        chdir: 'C:\ProgramData\Evaluate-STIG'

    ###################################################################
    # Determine Group-Based Folder Target
    ###################################################################
    - name: Set role folder name based on group
      set_fact:
        role_folder: |
          {% if 'domain_controllers' in group_names %}
          Domain-Controllers
          {% elif 'member_servers' in group_names %}
          Member-Servers
          {% else %}
          Workstations
          {% endif %}

    ###################################################################
    # Create Share Path + Upload Results
    ###################################################################
    - name: Ensure SMB destination folder exists
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ share_path }}" -Credential $cred -ErrorAction Stop | Out-Null

          $rolePath = "R:\{{ role_folder }}"
          $hostPath = "$rolePath\{{ inventory_hostname }}"

          if (-not (Test-Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }
          if (-not (Test-Path $hostPath)) { New-Item -ItemType Directory -Path $hostPath -Force | Out-Null }

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue
      no_log: true

    - name: üì§ Copy STIG results to SMB share
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ share_path }}" -Credential $cred -ErrorAction Stop | Out-Null

          robocopy "C:\Users\Public\Documents\STIG_Compliance\{{ inventory_hostname }}" `
                   "R:\{{ role_folder }}\{{ inventory_hostname }}" /E /NFL /NDL /NJH /NJS /NP

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    - name: ‚úÖ Summary
      ansible.builtin.debug:
        msg:
          - "‚úÖ STIG Scan completed on {{ inventory_hostname }}."
          - "üì§ Uploaded to: {{ share_path }}\\{{ role_folder }}\\{{ inventory_hostname }}"
