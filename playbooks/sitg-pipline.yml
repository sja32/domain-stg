---
- name: Full STIG Pipeline (Prep ‚Üí Scan ‚Üí Upload)
  hosts: all
  gather_facts: no

  vars:
    stig_version: "Evaluate-STIG_1.2507.5"
    eval_stig_source: "\\\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"
    eval_stig_dest: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_local: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:

    ###################################################################
    # PREP ‚Äî fresh deployment
    ###################################################################
    - name: üöÄ Remove existing Evaluate-STIG directory
      ansible.windows.win_powershell:
        script: |
          if (Test-Path "{{ eval_stig_dest }}") {
            Remove-Item "{{ eval_stig_dest }}" -Recurse -Force -ErrorAction SilentlyContinue
          }

    - name: Create Evaluate-STIG directory
      ansible.windows.win_file:
        path: "{{ eval_stig_dest }}"
        state: directory

    - name: Copy Evaluate-STIG to host (fresh deployment)
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

          New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ eval_stig_source }}" -Credential $cred -ErrorAction Stop | Out-Null
          Copy-Item "Z:\*" "{{ eval_stig_dest }}" -Recurse -Force
          Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

    ###################################################################
    # RUN SCAN
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_powershell:
        script: |
          Set-Location "{{ eval_stig_dest }}"
          Set-ExecutionPolicy Bypass -Scope Process -Force
          .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV" -ResultsPath "{{ stig_results_local }}"

    - name: ‚úÖ Scan Done
      ansible.builtin.debug:
        msg: "‚úÖ STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
    # COPY RESULTS TO SHARE
    ###################################################################
    - name: üì§ Copy STIG Results to SMB Share
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ smb_pass }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          $source = "{{ stig_results_local }}\\{{ ansible_hostname }}"
          $dest = "R:\\workstations\\{{ ansible_hostname }}"

          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }

          Copy-Item $source\* $dest -Recurse -Force

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    - name: ‚úÖ Summary
      ansible.builtin.debug:
        msg:
          - "Completed on: {{ inventory_hostname }}"
          - "Local Results: {{ stig_results_local }}\\{{ ansible_hostname }}"
          - "Uploaded To: {{ smb_share_root }}\\workstations\\{{ ansible_hostname }}"
