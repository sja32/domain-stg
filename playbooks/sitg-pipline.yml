---
- name: Prepare, Scan, and Upload STIG Results
  hosts: all
  gather_facts: no

  vars:
    # Paths for Evaluate-STIG deployment
    stig_share_path: "\\\\192.168.10.198\\Evaluate-STIG\\Evaluate-STIG_1.2507.5"
    stig_local_path: "C:\\ProgramData\\Evaluate-STIG_1.2507.5"

    # Default output folder Evaluate-STIG uses
    stig_results_path: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # SMB Share for results
    results_share_root: "\\\\192.168.10.198\\STIG-Results"

  tasks:
    ###################################################################
    # PREP HOST
    ###################################################################
    - name: üöÄ Start Prep
      ansible.builtin.debug:
        msg: "Preparing {{ inventory_hostname }} for Evaluate-STIG deployment"

    - name: Remove existing Evaluate-STIG folder (force refresh)
      ansible.windows.win_powershell:
        script: |
          if (Test-Path "{{ stig_local_path }}") {
              Remove-Item "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
          }

    - name: Recreate folder cleanly
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: Copy Evaluate-STIG files to ProgramData (using AWX injected credentials)
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

          New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_path }}" -Credential $cred -ErrorAction Stop | Out-Null
          Copy-Item "Z:\*" "{{ stig_local_path }}" -Recurse -Force
          Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue

    - name: ‚úÖ Deployment Done
      ansible.builtin.debug:
        msg: "‚úÖ Evaluate-STIG deployed to {{ stig_local_path }}"

    ###################################################################
    # RUN STIG SCAN (your dotnet test speed config)
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "{{ stig_local_path }}"
        .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV"
      args:
        executable: PowerShell.exe

    - name: ‚úÖ Scan Done
      ansible.builtin.debug:
        msg: "‚úÖ STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
    # COPY RESULTS ‚Üí SHARE
    ###################################################################
    - name: üóÇ Determine role name folder (based on inventory group)
      set_fact:
        stig_role_folder: "{{ group_names[0] | lower }}"

    - name: Ensure SMB destination folder exists
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ results_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          $path = "R:\\{{ stig_role_folder }}\\{{ inventory_hostname }}"
          if (-not (Test-Path $path)) { New-Item -ItemType Directory -Path $path -Force | Out-Null }

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    - name: üì§ Copy STIG results to SMB share
      ansible.windows.win_powershell:
        script: |
          $sec = ConvertTo-SecureString "{{ ansible_password }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("{{ ansible_user }}", $sec)

          New-PSDrive -Name R -PSProvider FileSystem -Root "{{ results_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

          Copy-Item "{{ stig_results_path }}\\{{ inventory_hostname }}\\Checklist\\*" `
            "R:\\{{ stig_role_folder }}\\{{ inventory_hostname }}\\" -Recurse -Force

          Remove-PSDrive -Name R -Force -ErrorAction SilentlyContinue

    - name: ‚úÖ Summary
      debug:
        msg:
          - "‚úÖ Completed on: {{ inventory_hostname }}"
          - "üìÅ Source: {{ stig_results_path }}\\{{ inventory_hostname }}\\Checklist"
          - "üì§ Uploaded to: {{ results_share_root }}\\{{ stig_role_folder }}\\{{ inventory_hostname }}"
