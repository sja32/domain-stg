---
- name: Full STIG Pipeline (Prep ‚Üí Scan ‚Üí Upload)
  hosts: all
  gather_facts: yes  # for ansible_hostname

  vars:
    # === Your existing variable names (from group/host vars) ===
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_share_path: "\\\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"   # <-- SOURCE on fileserver
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"                      # <-- DEST on host
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\STIG-Results"                          # final drop
    # prefer explicit role var, fall back to group name for folder
    role_folder: "{{ stig_role_folder | default((group_names | first | lower) | replace('-', '_')) }}"

    # Pull SMB creds from survey (preferred), or fall back to AWX machine creds if set there
    smb_user_effective: "{{ smb_user | default(ansible_user | default('')) }}"
    smb_pass_effective: "{{ smb_pass | default(ansible_password | default('')) }}"

  tasks:
    ###################################################################
    # PREP: deploy (or refresh) Evaluate-STIG to the host
    ###################################################################
    - name: üöÄ Remove existing Evaluate-STIG directory
      ansible.windows.win_powershell:
        script: |
          if (Test-Path "{{ stig_local_path }}") {
            Remove-Item -Path "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
          }

    - name: Create Evaluate-STIG directory
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: Copy Evaluate-STIG to host (fresh deployment)
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          New-PSDrive -Name 'Z' -PSProvider FileSystem -Root '{{ stig_share_path }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {
            Copy-Item -Path 'Z:\*' -Destination '{{ stig_local_path }}' -Recurse -Force -ErrorAction Stop
          } finally {
            Remove-PSDrive -Name 'Z' -Force -ErrorAction SilentlyContinue
          }

    ###################################################################
    # SCAN: run Evaluate-STIG (CKL + CSV) with execution policy bypass
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV)
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "C:\ProgramData\{{ stig_version }}"
        .\Evaluate-STIG.ps1 -selectstig dotnet4 -Output "CKL,CSV, Summary"
      args:
        executable: PowerShell.exe

    - name: ‚úÖ Scan Done
      ansible.builtin.debug:
        msg: "‚úÖ STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
    # UPLOAD: copy **Checklist** and **SummaryReport.xml** results
    # to \\server\STIG-Results\<role>\<host>
    ###################################################################
    - name: üì§ Copy STIG Results (Checklist + SummaryReport.xml) to SMB Share
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $srcRoot   = '{{ stig_results_root }}'
          $hostName  = $env:COMPUTERNAME
          $srcHost   = Join-Path -Path $srcRoot -ChildPath $hostName
          $srcChecks = Join-Path -Path $srcHost -ChildPath 'Checklist'
          $srcSummary = Join-Path -Path $srcHost -ChildPath 'SummaryReport.xml'

          if (-not (Test-Path -Path $srcChecks)) {
            throw "No Evaluate-STIG results at $srcChecks"
          }

          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          New-PSDrive -Name 'R' -PSProvider FileSystem -Root '{{ smb_share_root }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {
            $rolePath = Join-Path -Path 'R:\' -ChildPath '{{ role_folder }}'
            if (-not (Test-Path -Path $rolePath)) { New-Item -ItemType Directory -Path $rolePath -Force | Out-Null }

            $destHost = Join-Path -Path $rolePath -ChildPath $hostName
            if (-not (Test-Path -Path $destHost)) { New-Item -ItemType Directory -Path $destHost -Force | Out-Null }

            # Copy Checklist folder contents
            Copy-Item -Path (Join-Path $srcChecks '*') -Destination (Join-Path $destHost 'Checklist') -Recurse -Force

            # Copy SummaryReport.xml if it exists
            if (Test-Path $srcSummary) {
              Copy-Item -Path $srcSummary -Destination (Join-Path $destHost 'SummaryReport.xml') -Force
            }

            "Copied results and summary to $destHost"
          } finally {
            Remove-PSDrive -Name 'R' -Force -ErrorAction SilentlyContinue
          }

    - name: ‚úÖ Summary
      ansible.builtin.debug:
        msg:
          - "üìÅ Local results: {{ stig_results_root }}\\{{ ansible_hostname }}\\Checklist"
          - "üßæ Summary: {{ stig_results_root }}\\{{ ansible_hostname }}\\SummaryReport.xml"
          - "üì§ Uploaded to: {{ smb_share_root }}\\{{ role_folder }}\\{{ ansible_hostname }}"
