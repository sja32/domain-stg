---
- name: Full STIG Pipeline (Prep ‚Üí Scan ‚Üí Upload)
  hosts: all
  gather_facts: yes  # for ansible_hostname

  vars:
    # === Your existing variable names (from group/host vars) ===
    stig_version: "Evaluate-STIG_1.2507.5"
    stig_share_path: "\\\\192.168.10.198\\Evaluate-STIG\\{{ stig_version }}"
    stig_local_path: "C:\\ProgramData\\{{ stig_version }}"
    stig_results_root: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\STIG-Results"
    role_folder: "{{ stig_role_folder | default((group_names | first | lower) | replace('-', '_')) }}"

    # SMB creds from survey or fallback to inventory vars
    smb_user_effective: "{{ smb_user | default(ansible_user | default('')) }}"
    smb_pass_effective: "{{ smb_pass | default(ansible_password | default('')) }}"

  tasks:
    ###################################################################
    # PREP: deploy (or refresh) Evaluate-STIG to the host
    ###################################################################
    - name: üöÄ Remove existing Evaluate-STIG directory
      ansible.windows.win_powershell:
        script: |
          if (Test-Path "{{ stig_local_path }}") {
            Remove-Item -Path "{{ stig_local_path }}" -Recurse -Force -ErrorAction SilentlyContinue
          }

    - name: Create Evaluate-STIG directory
      ansible.windows.win_file:
        path: "{{ stig_local_path }}"
        state: directory

    - name: Copy Evaluate-STIG to host (fresh deployment)
      no_log: true
      ansible.windows.win_powershell:
        script: |
          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ('{{ smb_user_effective }}', $sec)

          New-PSDrive -Name 'Z' -PSProvider FileSystem -Root '{{ stig_share_path }}' -Credential $cred -ErrorAction Stop | Out-Null
          try {
            Copy-Item -Path 'Z:\*' -Destination '{{ stig_local_path }}' -Recurse -Force -ErrorAction Stop
          } finally {
            Remove-PSDrive -Name 'Z' -Force -ErrorAction SilentlyContinue
          }

    ###################################################################
    # SCAN: run Evaluate-STIG (CKL + CSV) with execution policy bypass
    ###################################################################
    - name: ‚ñ∂Ô∏è Run Evaluate-STIG scan (CKL + CSV + Summary)
      ansible.windows.win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        Set-Location "C:\ProgramData\{{ stig_version }}"
        .\Evaluate-STIG.ps1 -Output "CKL,CSV,Summary"
      args:
        executable: PowerShell.exe

    - name: ‚úÖ Scan Done
      ansible.builtin.debug:
        msg: "‚úÖ STIG Scan complete on {{ inventory_hostname }}"

    ###################################################################
    # UPLOAD (PowerShell-only, clean copy)
    ###################################################################
    - name: üì§ Copy STIG Results to SMB Share (clean + selective copy)
      no_log: true
      ansible.windows.win_powershell:
        script: |
          param(
            [string]$StigRoot,
            [string]$SmbRoot,
            [string]$RoleFolder
          )

          $HostName = $env:COMPUTERNAME

          # Local STIG path for this host
          $LocalHostPath = Join-Path -Path $StigRoot -ChildPath $HostName
          if (-not (Test-Path $LocalHostPath)) {
              throw "Local Evaluate-STIG folder not found: $LocalHostPath"
          }

          $LocalChecklist = Join-Path -Path $LocalHostPath -ChildPath "Checklist"
          $LocalSummary   = Join-Path -Path $LocalHostPath -ChildPath "SummaryReport.xml"

          if (-not (Test-Path $LocalChecklist)) {
              throw "Checklist folder not found at $LocalChecklist"
          }
          if (-not (Test-Path $LocalSummary)) {
              throw "SummaryReport.xml not found at $LocalSummary"
          }

          # SMB Authentication
          $sec  = ConvertTo-SecureString '{{ smb_pass_effective }}' -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential('{{ smb_user_effective }}', $sec)

          # Mount SMB share as drive R:
          New-PSDrive -Name 'R' -PSProvider FileSystem -Root $SmbRoot -Credential $cred -ErrorAction Stop | Out-Null

          try {
              # Build role folder path on the SMB share
              $RolePath = Join-Path -Path 'R:\' -ChildPath $RoleFolder
              if (-not (Test-Path $RolePath)) { New-Item -ItemType Directory -Path $RolePath -Force | Out-Null }

              # Build host folder path
              $DestHost = Join-Path -Path $RolePath -ChildPath $HostName

              # DELETE old host folder
              if (Test-Path $DestHost) {
                  Write-Host "Removing old host folder at $DestHost"
                  Remove-Item -Path $DestHost -Recurse -Force -ErrorAction SilentlyContinue
              }

              # Recreate clean destination
              New-Item -ItemType Directory -Path $DestHost -Force | Out-Null

              # Copy ONLY the Checklist folder
              $DestChecklist = Join-Path -Path $DestHost -ChildPath 'Checklist'
              Write-Host "Copying Checklist folder to $DestChecklist"
              Copy-Item -Path $LocalChecklist -Destination $DestChecklist -Recurse -Force

              # Copy ONLY SummaryReport.xml
              $DestSummary = Join-Path -Path $DestHost -ChildPath 'SummaryReport.xml'
              Write-Host "Copying SummaryReport.xml to $DestSummary"
              Copy-Item -Path $LocalSummary -Destination $DestSummary -Force

              Write-Host "Copy completed for $HostName"
          }
          finally {
              Remove-PSDrive -Name 'R' -Force -ErrorAction SilentlyContinue
          }
        parameters:
          StigRoot: "{{ stig_results_root }}"
          SmbRoot: "{{ smb_share_root }}"
          RoleFolder: "{{ role_folder }}"

    - name: ‚úÖ Summary
      ansible.builtin.debug:
        msg:
          - "üìÅ Local results: {{ stig_results_root }}\\{{ ansible_hostname }}\\Checklist"
          - "üì§ Uploaded to: {{ smb_share_root }}\\{{ role_folder }}\\{{ ansible_hostname }}"
