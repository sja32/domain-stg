---
# Playbook: run-evaluate-stig-scan.yml
# Purpose: Run Evaluate-STIG scan and upload results to Synology SMB share
# Runs scan entirely local â†’ then copies results in one PS session

- name: Run Evaluate-STIG scan and upload results
  hosts: domain_controllers
  gather_facts: no

  vars:
    # Adjust ONLY these 3 paths to match your environment:
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5\\Evaluate-STIG"
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance"

    # âœ… Your Synology STIG-Results share
    smb_share_root: "\\\\192.168.10.198\\stig-results"

    # âœ… Use your svc-ansible account (no need for env vars)
    smb_user: "voughtnet\\svc-ansible"
    smb_pass: "Luasi965!"   # <-- you can vault this later

  tasks:

    - name: Ensure Evaluate-STIG working directory exists
      ansible.windows.win_file:
        path: "{{ stig_workdir }}"
        state: directory

    - name: Run Evaluate-STIG scan
      ansible.windows.win_shell: |
        Write-Host "ðŸ” Running Evaluate-STIG scan on $env:COMPUTERNAME..."
        if (-not (Test-Path "{{ stig_workdir }}\\Evaluate-STIG.ps1")) {
            throw "âŒ Evaluate-STIG.ps1 not found in {{ stig_workdir }}"
        }
        Set-Location "{{ stig_workdir }}"
        .\\Evaluate-STIG.ps1 -Output ckl -Summary
        Write-Host "âœ… STIG scan completed."
      args:
        executable: PowerShell.exe
      register: stig_scan

    - name: Ensure local results directory exists
      ansible.windows.win_file:
        path: "{{ stig_results }}"
        state: directory

    - name: Upload STIG results to Synology share
      ansible.windows.win_shell: |
        $user = "{{ smb_user }}"
        $pass = "{{ smb_pass }}"
        $secure = ConvertTo-SecureString $pass -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ($user, $secure)

        $dest = "{{ smb_share_root }}\\{{ inventory_hostname }}"

        Write-Host "ðŸ”„ Mapping drive for upload..."
        New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        if (-not (Test-Path "Z:\\{{ inventory_hostname }}")) {
            New-Item -Path "Z:\\{{ inventory_hostname }}" -ItemType Directory | Out-Null
        }

        Write-Host "â¬†ï¸ Copying STIG results to $dest ..."
        Copy-Item -Path "{{ stig_results }}\\*" -Destination "Z:\\{{ inventory_hostname }}" -Recurse -Force

        Write-Host "âœ… Results successfully uploaded to $dest"

        Remove-PSDrive -Name Z -Force -ErrorAction SilentlyContinue
      args:
        executable: PowerShell.exe
      register: upload_result

    - name: Display Summary
      debug:
        msg:
          - "âœ… STIG Scan completed on {{ inventory_hostname }}"
          - "ðŸ“¤ Results uploaded to: {{ smb_share_root }}\\{{ inventory_hostname }}"
