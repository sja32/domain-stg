---
- name: Run Evaluate-STIG scan and upload results
  hosts: domain_controllers
  gather_facts: no

  vars:
    stig_workdir: "C:\\ProgramData\\Evaluate-STIG_1.2507.5\\Evaluate-STIG"
    stig_results: "C:\\Users\\Public\\Documents\\STIG_Compliance"
    smb_share_root: "\\\\192.168.10.198\\stig-results"
    smb_user: "voughtnet\\svc-ansible"
    smb_pass: "Luasi965!"   # (or vault this later)

  tasks:

    - name: Ensure STIG results directory exists
      ansible.windows.win_file:
        path: "{{ stig_results }}"
        state: directory

    - name: Run Evaluate-STIG scan - CKL output only
      ansible.windows.win_shell: |
        Set-Location "{{ stig_workdir }}"
        .\Evaluate-STIG.ps1 -Output ckl
      args:
        executable: PowerShell.exe
      register: stig_scan_result
      changed_when: true

    - name: Create hostname folder on share
      ansible.windows.win_shell: |
        $pass = "{{ smb_pass }}" | ConvertTo-SecureString -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $pass)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null
        if (-not (Test-Path "R:\\{{ inventory_hostname }}")) {
            New-Item -ItemType Directory -Path "R:\\{{ inventory_hostname }}" | Out-Null
        }
        Remove-PSDrive -Name R -Force
      args:
        executable: PowerShell.exe

    - name: Upload entire STIG_Compliance folder to share
      ansible.windows.win_shell: |
        $pass = "{{ smb_pass }}" | ConvertTo-SecureString -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("{{ smb_user }}", $pass)
        New-PSDrive -Name R -PSProvider FileSystem -Root "{{ smb_share_root }}" -Credential $cred -ErrorAction Stop | Out-Null

        $src = "{{ stig_results }}"
        $dest = "R:\\{{ inventory
