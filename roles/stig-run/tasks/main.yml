---
- name: Ensure Evaluate-STIG directory exists
  ansible.windows.win_file:
    path: "{{ eval_stig_dest }}"
    state: directory

- name: Copy Evaluate-STIG package from file share
  ansible.windows.win_copy:
    src: "{{ eval_stig_source }}\\"
    dest: "{{ eval_stig_dest }}\\"
    remote_src: yes

# 1️⃣ Import Signing Certificates
- name: Import Evaluate-STIG Code Signing Certificates
  ansible.windows.win_shell: |
    Set-Location "{{ eval_stig_dest }}\\Prerequisites"
    .\Import-Certificates.bat
  args:
    chdir: "{{ eval_stig_dest }}\\Prerequisites"
  register: cert_import

- name: Display cert import result
  debug:
    var: cert_import.stdout_lines

# 2️⃣ Test Prerequisites
- name: Validate Evaluate-STIG Prerequisites
  ansible.windows.win_shell: |
    Set-Location "{{ eval_stig_dest }}\\Prerequisites"
    .\Test-Prerequisites.bat
  register: prereq_test

- name: Show prerequisites test results
  debug:
    var: prereq_test.stdout_lines

# 3️⃣ Unblock any downloaded/NTFS-protected files
- name: Unblock Evaluate-STIG files
  ansible.windows.win_shell: |
    Get-ChildItem "{{ eval_stig_dest }}" -Recurse | Unblock-File

# 4️⃣ Run Evaluate-STIG Scan
- name: Run Evaluate-STIG scan
  ansible.windows.win_shell: |
    Set-Location "{{ eval_stig_dest }}"
    .\Evaluate-STIG.ps1 -Output ckl
  register: stig_output

- name: Show scan output summary
  debug:
    msg: "{{ stig_output.stdout }}"
