---
- name: Copy run_stig_scan.ps1 to ProgramData
  ansible.windows.win_copy:
    src: "run_stig_scan.ps1"
    dest: "C:\\ProgramData\\run_stig_scan.ps1"

- name: Beautiful STIG Runner
  ansible.windows.win_shell: |
    function Banner($Text) { Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan; Write-Host " $Text" -ForegroundColor White; Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`n" -ForegroundColor Cyan }

    Banner "ğŸš€  Starting Evaluate-STIG Scan on $env:COMPUTERNAME"

    $User = "{{ ansible_user }}"
    $Pass = "{{ ansible_password }}" | ConvertTo-SecureString -AsPlainText -Force
    $Cred = New-Object System.Management.Automation.PSCredential($User, $Pass)

    Write-Host "ğŸ”„  Mapping Evaluate-STIG Share..." -NoNewline
    New-PSDrive -Name Z -PSProvider FileSystem -Root "{{ stig_share_eval }}" -Credential $Cred -ErrorAction Stop
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "ğŸ“  Ensuring Local Install Folder Exists..." -NoNewline
    if (-Not (Test-Path "{{ stig_local_path }}")) {
        New-Item -ItemType Directory -Path "{{ stig_local_path }}" | Out-Null
        Copy-Item "Z:\{{ stig_version }}" "{{ stig_local_path }}" -Recurse -Force
    }
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "ğŸ”“  Importing STIG Certificates..." -NoNewline
    & "{{ stig_local_path }}\Prerequisites\Import-Certificates.bat"
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "ğŸ§ª  Running STIG Prerequisite Tests..." -NoNewline
    & "{{ stig_local_path }}\Prerequisites\Test-Prerequisites.bat"
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "`nğŸ”  Executing Evaluate-STIG Scan... (this may take several minutes)`n"
    cd "{{ stig_local_path }}"
    .\Evaluate-STIG.ps1 -Output ckl -Summary

    Write-Host "`nğŸ”„  Mapping STIG Results Share..." -NoNewline
    New-PSDrive -Name R -PSProvider FileSystem -Root "{{ stig_share_results }}" -Credential $Cred -ErrorAction Stop
    Write-Host " âœ…" -ForegroundColor Green

    $HN = $env:COMPUTERNAME

    Write-Host "ğŸ“‚  Preparing Results Folder for $HN..." -NoNewline
    New-Item -Path "R:\$HN" -ItemType Directory -Force | Out-Null
    Write-Host " âœ…" -ForegroundColor Green

    Write-Host "â¬†ï¸  Uploading Results..."
    Copy-Item "{{ stig_results_local }}\*" "R:\$HN" -Recurse -Force

    Write-Host "`nâœ…  STIG Scan Complete for $HN" -ForegroundColor Green
    Write-Host "ğŸ“‚  Results: \\192.168.10.198\\stig-results\\$HN"
  register: stig_output

- debug:
    var: stig_output.stdout_lines
